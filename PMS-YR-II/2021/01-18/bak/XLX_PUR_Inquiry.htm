<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <script src="/Scripts/boot.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/ComTools.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/WebForm.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Form/Init/$Model.data.FormId/$Model.data.FormState/$Model.data.KeyValue"></script>

    <script language="javascript" src="/Scripts/PlatForm/ControlCenter.js?v=$AppVersion"></script>
    <script language="javascript" src="/Scripts/PlatForm/WorkFlowsEnums.js?v=$AppVersion"></script>
    <script language="javascript" src="/Scripts/PlatForm/WorkFlowsForm.js?v=$AppVersion"></script>
    <link href="/Scripts/plugins/uploadify/uploadify.css" rel="stylesheet" type="text/css" />
    <script src="/Scripts/plugins/uploadify/jquery.uploadify.html5.js" type="text/javascript"></script>

    <script type="text/javascript" hasvelocity="true">
        var KeyValue = "$Model.data.KeyValue";
        var FormId = "$Model.data.FormId";
        var FormState = "$Model.data.FormState";
        var FormParams = $Model.data.FormParams;

        var DeptName = "$!CurrentSession.DeptName";
        var ProjectID="$!CurrentSession.EpsProjId";
        var ProjectName = "$!CurrentSession.EpsProjName";
        var HumanId = "$!CurrentSession.HumanId";
        var HumanName = "$!CurrentSession.HumanName";

        var NowDate=getdate();	//ComTools 获取当前日期 2013-01-02
        var now = new Date();
        var NYear = now.getFullYear();
        var NMonth = now.getMonth()+1;
    </script>
</head>
<body>
    <div class="row" style="height: 100%">
        <div class="portlet box blue" style="height: 100%">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-cogs"></i><span>采购审批单</span>
                </div>
                $!WorkFlowButtons
                <div class="actions">
                    <a class="mini-button blue" id="XLX_PUR_Inquiry.InquiryOnline" onclick="InquiryOnline()"><i class="fa fa-plus"></i>在线询价</a>
                    <a class="mini-button blue" id="XLX_PUR_Inquiry.Save" onclick="PowerForm.OnBtnSave(this)"><i class="fa fa-save"></i>保存</a>
                    <a class="mini-button blue" id="XLX_PUR_Inquiry.Refresh" onclick="PowerForm.OnBtnRefresh(this)"><i class="fa fa-refresh"></i>刷新</a>
                    <div id="btnPrint" class="btn-group"></div>
                    <a class="mini-button blue" id="XLX_PUR_Inquiry.CloseForm" onclick="PowerForm.OnBtnCloseForm(this)"><i class="fa fa-power-off"></i>关闭</a>
                </div>
            </div>
            <div class="mini-fit">
                <div class="portlet-body" style="height: 100%;">
                    <div id="maintabs" class="mini-tabs" tabposition="left" tabalign="left" style="height: 100%;">
                        <div title="通常" iconcls="fa fa-h-square">
                            <div id="XLX_PUR_Inquiry" class="form">
                                <table class="table table-bordered">
                                    <tr>
                                        <td>采购审批单号</td>
                                        <td><input id="XLX_PUR_Inquiry.InquiryCode" name="InquiryCode" class="mini-textbox" /></td>
                                        <td>状态</td>
                                        <td><input id="XLX_PUR_Inquiry.Status" name="Status" class="mini-combobox" readonly="readonly"/></td>
                                    </tr>
                                    <tr>
                                        <td>标题</td>
                                        <td><input id="XLX_PUR_Inquiry.Title" name="Title" class="mini-textbox" required="true" /></td>
                                        <td>询价日期</td>
                                        <td><input id="XLX_PUR_Inquiry.InquiryDate" name="InquiryDate" class="mini-datepicker" format="yyyy-MM-dd" valuetype="String" allowinput="false" required="true" /></td>
                                    </tr>
                                      <tr>
                                        <td>是否境外合同</td>
                                        <td><input id="XLX_PUR_Inquiry.Overseas" name="Overseas" class="mini-combobox" required="true" /></td>
                                        <td>类别</td>
                                        <td><input id="XLX_PUR_Inquiry.BuyerType" name="BuyerType" class="mini-combobox" /></td>
                                    </tr>
                                      <tr>
                                        <td>议价合计金额</td>
                                        <td><input id="XLX_PUR_Inquiry.TotalPrice" name="TotalPrice" class="mini-spinner" minValue="0" maxValue="999999999999"  format="n2"/></td>
                                        <td>是否有合同</td>
                                        <td><input id="XLX_PUR_Inquiry.Virtual" name="Virtual" class="mini-combobox" /></td>
                                    </tr>
                                    <tr>
                                        <td>合同编号/协议号/订单号</td>
                                        <td >
                                            <input id="XLX_PUR_Inquiry.ContractCode" name="ContractCode" class="mini-textbox" required="true" />
                                        </td>
                                        <td>报价供应商</td>
                                        <td>
                                            <input id="XLX_PUR_Inquiry.SupplieName" name="SupplieName" class="mini-textbox" readonly="readonly" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>业务员姓名</td>
                                        <td>
                                            <input id="XLX_PUR_Inquiry.BuyerId" name="BuyerId" class="mini-textbox" style="display:none" />
                                            <input id="XLX_PUR_Inquiry.BuyerName" name="BuyerName" textname="BuyerName" class="mini-buttonedit" required allowinput="false" onbuttonclick="PowerForm.OnBtnWizard(this)" />
                                        </td>
                                        <td>联系电话</td>
                                        <td><input id="XLX_PUR_Inquiry.Phone" name="Phone" class="mini-textbox" required="true" /></td>
                                    <tr>
                                    <tr>
                                        <td>备注说明</td>
                                        <td colspan="3"><textarea class="mini-textarea" id="XLX_PUR_Inquiry.Memo" name="Memo" height="100px"></textarea></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            项目名称
                                        </td>
                                        <td>
                                            <input id="XLX_PUR_Inquiry.OwnProjName" name="OwnProjName" class="mini-textbox" readonly />
                                        </td>
                                        <!-- <td>报价截止日期</td>
                                        <td><input id="XLX_PUR_Inquiry.InquiryEndDate" name="InquiryEndDate" class="mini-datepicker" format="yyyy-MM-dd HH:mm" showOkButton="true" showTime="true" required/></td> -->
                                    </tr>
                                    <tr>
                                        <td>录入人</td>
                                        <td><input id="XLX_PUR_Inquiry.RegHumName" name="RegHumName" class="mini-textbox" readonly="readonly" /></td>
                                        <td>录入日期</td>
                                        <td><input id="XLX_PUR_Inquiry.RegDate" name="RegDate" class="mini-datepicker" readonly="readonly" /></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div title="物料明细">
                            <div class="mini-toolbar">
								<a class="mini-button blue" iconcls="fa-plus" id="XLX_PUR_Inquiry_MatList.Add" onclick="AddMat(this)">新增</a>
                                <a class="mini-button blue" iconcls="fa-plus" id="XLX_PUR_Inquiry_MatList.Add1" onclick="PowerForm.OnBtnWizard(this)">选择补录数据</a>
								<a class="mini-button blue" iconcls="fa-trash-o" id="XLX_PUR_Inquiry_MatList.Delete" onclick="PowerForm.OnBtnDel(this)">删除</a><!--删除-->
                                <div id="XLX_PUR_Inquiry_MatList-Export" class="btn-group"></div>
                            </div>
                            <div class="mini-fit">
                                <div id="XLX_PUR_Inquiry_MatList" class="mini-datagrid" style="width: 100%; height: 100%;" idfield="Id" ondrawcell="DrawCell"
                                     showpager="false" allowcellselect="true" allowcelledit="true" multiselect="true" allowcellvalid="true" allowalternating="true"
                                     oncellendedit="cellendeditMatList" editnextonenterkey="true" data-options="{canImport:true}" showsummaryrow="true" virtualScroll="true" sortField=" MatCode desc">
                                    <div property="columns">
                                        <div type="checkcolumn"></div><!--复选框组-->
                                        <div type="indexcolumn" width="45">序号</div>
                                        <div field="Request_Id" width="0" headerAlign="center" allowSort="true">请购主键</div>
                                        <div field="MatName" width="100" headerAlign="center" allowSort="true">物料名称</div>
                                        <div field="Model" width="200" headerAlign="center" allowSort="true">物资描述</div>
                                        <div field="Specifi" width="160" headerAlign="center" allowSort="true">规格型号</div>
                                        <div field="MatUnit" width="100" headerAlign="center" allowSort="true">单位</div>
                                        <div field="Qty_Request" width="100" headerAlign="center" allowSort="true" summarytype="sum">
                                            请购数量
                                        </div>
                                        <div field="InquiryUnit" width="80" headerAlign="center" allowSort="true" vtype="required">
                                            询价单位
                                            <input property="editor" class="mini-textbox" style="width: 100%;" />
                                        </div>
                                        <div field="Qty_Inquiry" width="100" headerAlign="center" allowSort="true" summarytype="sum">
                                            询价数量
                                            <input property="editor" class="mini-spinner" style="width: 100%;" minValue="0" maxValue="999999999999" />
                                        </div>
                                        <div field="Standard" width="100" headerAlign="center" allowSort="true">制造标准</div>
                                        <div field="Texture" width="100" headerAlign="center" allowSort="true">材质</div>
                                        <div field="Pattern" width="100" headerAlign="center" allowSort="true">型式</div>
                                        <div field="MatBS_Name" width="100" headerAlign="center" allowSort="true">物资类别名称</div>
                                        <div field="MatCode" width="130" headerAlign="center" allowSort="true">物料编码</div>
                                        <div field="RequestCode" width="150" headerAlign="center" allowSort="true" summarytype="count">请购编号</div>
                                        <div field="MatSpec" width="80" headerAlign="center" allowSort="true">
                                            装置
                                        </div>
                                        <div field="TagNumber" width="80" headerAlign="center" allowSort="true">
                                            位号
                                        </div>
                                        <div field="Remark" width="120" headerAlign="center" allowSort="true">
                                            备注
                                            <input property="editor" class="mini-textarea" style="width:100%;" minWidth="200" minHeight="50" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div title="供应商名单">
                            <div class="mini-toolbar">
                                <a class="mini-button blue" iconcls="fa-plus" id="XLX_PUR_Inquiry_SupplieList.Add" onclick="PowerForm.OnBtnWizard(this)">新增</a><!--新增(向导)-->
                                <a class="mini-button blue" iconcls="fa-trash-o" id="XLX_PUR_Inquiry_SupplieList.Delete" onclick="PowerForm.OnBtnDel(this)">删除</a><!--删除-->
                                <div id="XLX_PUR_Inquiry_SupplieList-Print" class="btn-group"></div>
                                <div id="XLX_PUR_Inquiry_SupplieList-Export" class="btn-group"></div>
                                <a class="mini-button blue" iconcls="fa-apple" id="MaintainSupply" onclick="MaintainSupply">查看供应商</a>
                            </div>
                            <div class="mini-fit">
                                <div id="XLX_PUR_Inquiry_SupplieList" class="mini-datagrid" style="width: 100%; height: 100%;" idfield="Id"
                                     oncellbeginedit="begineditSupplieList" oncellendedit="endeditSupplieList" showpager="false" allowcellselect="true" allowcelledit="true" multiselect="true" allowcellvalid="true" allowalternating="true"
                                     editnextonenterkey="true" data-options="{canImport:true}">
                                    <div property="columns">
                                        <div type="checkcolumn"></div><!--复选框组-->
                                        <div type="indexcolumn" width="45">序号</div><!--序号-->
                                        <div field="Code" width="100" allowsort="true" headeralign="Center">供应商编码</div>
                                        <div field="Name" width="200" allowsort="true" headeralign="Center">供应商名称</div>
                                        <!-- <div field="InquiryStatus" width="80" type="comboboxcolumn" allowsort="true">询价状态
                                            <input property="editor" class="mini-combobox" style="width: 100%;">
                                        </div>
                                        <div field="InquiryHumanName" headeralign="center" width="100">报价人员
                                            <input property="editor" id="XLX_PUR_Inquiry_SupplieList.InquiryHumanName" class="mini-buttonedit" name="InquiryHumanName" textname="InquiryHumanName" onbuttonclick="PowerForm.OnBtnWizard(this,true)" allowinput="false" style="width: 100%;" />
                                        </div> -->
                                        <div field="Email" width="160" allowsort="true" headeralign="Center">EMail地址<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                        <div field="Linkman" width="60" allowsort="true" headeralign="Center">联系人<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                        <div field="Phone" width="110" allowsort="true" headeralign="Center">电话<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
										<div field="TaxRate" width="60" allowsort="true" headeralign="Center" align="Center">税率%<input property="editor" class="mini-spinner" style="width: 100%;" allowlimitvalue="true" minvalue="0" maxvalue="100" changeonmousewhere="false" /></div>
										<div field="Invoice" width="110" allowsort="true" headeralign="Center" align="Center">发票类型<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
										<div field="CurrencyType" width="60" allowsort="true" headeralign="Center" align="Center">币别<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
										<div field="Method" width="80" allowsort="true" headeralign="Center" align="Center">交货方式<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
										<div field="Delivery" width="80" allowsort="true" headeralign="Center" align="Center">交期<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
										<div field="condition" width="120" allowsort="true" headeralign="Center">商务条件<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                        <div field="Warranty" width="80" allowsort="true" headeralign="Center" align="Center">保修期<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                        <div field="PaymentMethod" width="80" allowsort="true" headeralign="Center">支付方式<input property="editor" class="mini-textarea" style="width: 100%;" /></div>
                                        <div field="SettlementMethod" width="80" allowsort="true" headeralign="Center">结算方式<input property="editor" class="mini-textarea" style="width: 100%;" /></div>
                                        <div field="WarrantyAmount" width="80" allowsort="true" headeralign="Center">质保金<input property="editor" class="mini-spinner" style="width: 100%;" allowlimitvalue="true" minvalue="0" maxvalue="99999999" changeonmousewhere="false" /></div>
                                        <div field="DiscountMethod" width="80" allowsort="true" headeralign="Center">贴息方式<input property="editor" class="mini-textarea" style="width: 100%;" /></div>
                                        <div field="other" width="80" allowsort="true" headeralign="Center">其他条件<input property="editor" class="mini-textarea" style="width: 100%;" /></div>

                                        <div field="EName" width="100" allowsort="true" headeralign="Center">英文名称</div>
                                        <div field="ShortName" width="100" allowsort="true" headeralign="Center">供应商简称</div>
                                        <div field="TypeName" width="100" allowsort="true" headeralign="Center">供应商性质</div>
                                        <div field="ClassName" width="160" allowsort="true" headeralign="Center">供应商分类</div>
                                        <div field="Address" width="200" allowsort="true" headeralign="Center">地址</div>
                                        <div field="PostCode" width="100" allowsort="true" headeralign="Center">邮政编码</div>                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div title="报价明细">
                            <div class="mini-toolbar">
                                <a class="mini-button blue" id="View_XLX_InquirySupplie.CreateOrder" style="display:none;" onclick="PMS_CreateOrder()"><i class="fa fa-pencil"></i>生成采购订单</a>

                                <div id="btnUpload">  </div>
                                <div id="View_XLX_InquirySupplie-Export" title="采购审批单" class="btn-group"></div>
                                <a class="mini-button blue" iconcls="fa-plus" id="View_XLX_InquirySupplie.Expand" onclick="PMS_Expand()">展开</a>
                                <a class="mini-button blue" iconcls="fa-minus" id="View_XLX_InquirySupplie.Collapse" onclick="PMS_Collapse()">折叠</a>
                                <button class="btn blue" id="btnSave">
                                    <i class="fa fa-save"></i>保存当前<!--保存-->
                                </button>
                            </div>
                            <div class="mini-fit">
                                <div id="View_XLX_InquirySupplie" class="mini-datagrid" style="width: 100%; height: 100%;" idfield="ListId"
                                     showpager="false" allowcellselect="true" allowcelledit="true" multiselect="true" allowcellvalid="true"
                                     allowalternating="true" ondrawgroup="onDrawGroup" oncellendedit="oncellendedit" virtualScroll="true">
                                    <div property="columns">
                                        <div type="indexcolumn" field="ListId" width="45">序号</div><!--序号-->

                                          <div field="ListId" width="0" allowsort="true">主键</div>
                                        <div field="MatName" width="100" headeralign="center" allowsort="true">物料名称</div>
                                      
                                        <div field="Model" width="200" headerAlign="center" allowSort="true">物资描述</div>
                                        <div field="Specifi" width="160" headerAlign="center" allowSort="true">规格型号</div>                                       
                                        <div field="Qty_Inquiry" width="100" headeralign="center" allowsort="true"  NumberFormat="n2">
                                            询价数量
                                            <input property="editor" class="mini-spinner" style="width: 100%;" minValue="0" maxValue="999999999999" format="n2" readonly="readonly"/>                                 
                                        </div>
                                        <div field="MatUnit" width="100" headeralign="center" allowsort="true">询价单位</div>
                                        <div field="MatPrice" width="100" headeralign="center" allowsort="true">
                                            报价
                                            <input property="editor" class="mini-spinner" style="width: 100%;" minValue="0" maxValue="999999999999" format="n2"/>
                                        </div>
                                        <div field="MatMoney" width="100" headeralign="center" allowsort="true">
                                            报价总额
                                            <input property="editor" class="mini-spinner" style="width: 100%;" minValue="0" maxValue="999999999999" format="n2"/>
                                        </div>
                                        <div field="GoodsMatPrice" width="100" headeralign="center" allowsort="true">
                                            议价
                                            <input property="editor" class="mini-spinner" style="width: 100%;" minValue="0" maxValue="999999999999" format="n2"/>
                                        </div>
                                        <div field="GoodsMatMoney" width="100" headeralign="center" allowsort="true">
                                            议价总额
                                            <input property="editor" class="mini-spinner" style="width: 100%;" minValue="0" maxValue="999999999999" format="n2"/>
                                        </div>
                                        <div field="DeliveryDate" width="100" headeralign="center" dateformat="yyyy-MM-dd" allowsort="true">交货期</div>
                                        <div field="Pattern" width="100" headerAlign="center" allowSort="true">型式</div>
                                        <div field="Standard" width="100" headerAlign="center" allowSort="true">制造标准</div>
                                        <div field="Texture" width="100" headerAlign="center" allowSort="true">材质</div>   
                                  		<div field="RequestCode1" headeralign="center" width="160" summarytype="count">
                                            请购编号
                                        </div>
										<div field="Request_Id1" headeralign="center" width="0">
                                            请购主键
                                        </div>
                                        <div field="MatCode" width="100" headeralign="center" allowsort="true">物料编码</div>      
                                        <div field="Code" width="80" allowsort="true">供应商编码</div>
                                       
                                        <div field="Name" width="140" allowsort="true">供应商名称</div>
                                        <div field="MatSpec" width="80" headerAlign="center" allowSort="true">
                                            装置
                                        </div>
                                        <div field="TagNumber" width="80" headerAlign="center" allowSort="true">
                                            位号
                                        </div>
                                        <div field="PartyBName" width="80" headerAlign="center" allowSort="true">
                                            请购单位
                                        </div>
                                        <div field="Remark" width="120" headeralign="center" allowsort="true">
                                            备注
                                            <input property="editor" class="mini-textbox" style="width: 100%;"/>
                                        </div>
                                        <div field="Linkman" width="80" allowsort="true">联系人</div>
                                        <div field="Phone" width="180" allowsort="true">电话</div>
                                    </div>
                                </div>
                            </div>
                        </div>
						<div title="物资编码分组">
                            <div class="mini-toolbar">
                                <a class="mini-button blue" id="View_XLX_PUR_InquiryMatCode.CreateOrder" style="display:none;" onclick="PMS_CreateOrder()"><i class="fa fa-pencil"></i>生成采购订单</a>
                                <a class="mini-button blue" id="View_XLX_PUR_InquiryMatCode.Export" onclick="PowerForm.OnExportDataToXls('View_XLX_PUR_InquiryMatCode', '供应商报价',fz1)"><i class="fa fa-sign-out"></i>导出</a>
                                <a class="mini-button blue" iconcls="fa-plus" id="View_XLX_PUR_InquiryMatCode.Expand" onclick="PMS_Expand1()">展开</a>
                                <a class="mini-button blue" iconcls="fa-minus" id="View_XLX_PUR_InquiryMatCode.Collapse" onclick="PMS_Collapse1()">折叠</a>
                            </div>
                            <div class="mini-fit">
                                <div id="View_XLX_PUR_InquiryMatCode" class="mini-datagrid" style="width: 100%; height: 100%;" idfield="ListId"
                                     showpager="false" allowcellselect="true" allowcelledit="false" multiselect="true" allowcellvalid="true"
                                     allowalternating="true" ondrawgroup="onDrawGroup1" >
                                    <div property="columns">
                                        <div type="indexcolumn" width="45">序号</div><!--序号-->

                                          <div field="ListId" width="0" allowsort="true">主键</div>
                                          <div field="Code" width="80" allowsort="true">供应商编码</div>
                                        <div field="Name" width="140" allowsort="true">供应商名称</div>
                                        <div field="MatCode" width="100" headeralign="center" allowsort="true">物料编码</div>
                                        <div field="MatName" width="100" headeralign="center" allowsort="true">物料名称</div>
                                        <div field="Model" width="100" headeralign="center" allowsort="true">规格型号</div>
                                        <div field="Qty_Inquiry" width="100" headeralign="center" allowsort="true">询价数量</div>
                                        <div field="MatUnit" width="100" headeralign="center" allowsort="true">询价单位</div>
                                        <div field="MatPrice" width="100" headeralign="center" allowsort="true">报价</div>
                                        <div field="MatMoney" width="100" headeralign="center" allowsort="true">报价总额</div>
                                        <div field="GoodsMatPrice" width="100" headeralign="center" allowsort="true">订货价</div>
                                        <div field="GoodsMatMoney" width="100" headeralign="center" allowsort="true">订货总额</div>
                                        <div field="DeliveryDate" width="100" headeralign="center" dateformat="yyyy-MM-dd" allowsort="true">交货期</div>
                                        <div field="Remark" width="120" headeralign="center" allowsort="true">备注</div>
                                        <div field="Linkman" width="80" allowsort="true">联系人</div>
                                        <div field="Phone" width="180" allowsort="true">电话</div>
                                        <div field="PartyBName" width="80" headerAlign="center" allowSort="true">
                                            请购单位
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
						<div title ="供应商报价详情">
						   <div class="mini-toolbar">
						   </div>
						   <div class="mini-fit">
                                <div id="VIEW_XLX_PUR_Inquiry_MatList" class="mini-datagrid" style="width: 100%; height: 100%;" showpager="false">
                                    <div property="columns">
                                    </div>
                                </div>
                            </div>
						</div>
						<div id="attachfile" name="attachfile" title="附件" url=""></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">

        var PowerForm = new WebForm();
        var fz = "";
        var fz1 = "";
        var DaoChu = "";
		
		var SumTaxPirce = []; //各供应商含税总价
        $(function () {
            PowerForm.Init();
            FileUp("XLX_PUR_Inquiry_SupplieList", CreateGUID())//此处修改关键词
            //冻结列
            var grid = mini.get("XLX_PUR_Inquiry_MatList");
            var grid2 = mini.get("XLX_PUR_Inquiry_SupplieList");
            grid2.frozenColumns(0,2);

            var grid3 = mini.get("View_XLX_InquirySupplie");
            grid3.groupBy("Name", "ASC");
            fz = "供应商";
			
			var grid3 = mini.get("View_XLX_PUR_InquiryMatCode");
            grid3.groupBy("MatCode", "ASC");
            fz1 = "物资编码";
			
            //绑定字段事件
            mini.get('XLX_PUR_Inquiry_MatList').on("drawcell", function (e) {
                if (e.column.field == "RequestCode") {
                    if (!e.value) return false;
                    var record = e.record;
                    var sender = e.sender;
                    var id = record.Request_Id;
                    e.cellHtml = "<a href='javascript:void(0);' onclick=\"OpenFrom1('" + id + "')\">" + e.value + "</a>";
                }
				if (e.column.field == "RequestCode1") {
                    if (!e.value) return false;
                    var record = e.record;
                    var sender = e.sender;
                    var id = record.Request_Id1;
                    e.cellHtml = "<a href='javascript:void(0);' onclick=\"OpenFrom2('" + id + "')\">" + e.value + "</a>";
                }
            });			
        });
        mini.parse();


        //按钮
        //在线询价
        var inquiryOnline = mini.get("XLX_PUR_Inquiry.InquiryOnline"); 

        //grid
        //供应商
        var gdSupplieList = mini.get("XLX_PUR_Inquiry_SupplieList");
        //物资明细
        var gdMatList = mini.get("XLX_PUR_Inquiry_MatList");

        //控件
        //报价截止日期
        var inquiryEndDate = mini.get("XLX_PUR_Inquiry.InquiryEndDate");
        var sta = mini.get("XLX_PUR_Inquiry.Status");
        var title = mini.get("XLX_PUR_Inquiry.Title");

        //自定义


        //物资明细验证-询价数量不能大于请购数量
        function cellendeditMatList(e)
        {
            var record = e.record;
            var gridInquiry = mini.get("XLX_PUR_Inquiry_MatList");
            if(e.field == "Qty_Inquiry")
            {
                if(parseFloat(record.Qty_Inquiry)>parseFloat(record.Qty_Request))
                {
                    Power.ui.warning("询价数量不能大于请购数量");
                    gridInquiry.updateRow(record,{"Qty_Inquiry":0});
                }
            }
        }
        //供应商 询价状态禁止修改
        function begineditSupplieList(e){
            if (e.field == "InquiryStatus"){
                e.cancel = true;
            }
        }
        //供应商，邮箱格式验证
        function endeditSupplieList(e){
            var record = e.record;
            var reg = /^([a-z0-9]+[_|\_|\.]?)*[a-z0-9]+@([a-z0-9]+[_|\_|\.]?)*[a-z0-9]+\.[a-z]{2,3}$/;
            if(e.field == "Email"){
                if (reg.test(record.Email) == false){
                    Power.ui.warning("邮箱格式错误");
                    gdSupplieList.updateRow(record,{"Email":""});
                    return;
                }
            }
        }
        //维护供应商
        function MaintainSupply(){
            if(gdSupplieList.getSelected()){
                var rowsel = gdSupplieList.getSelected();
                if(!IsEmpty(rowsel.SupplieId)){
                    //判断打开供应商还是乙方单位
                    if(rowsel.WizardType == '0'){
                        ViewFormComn("04871cb2-c253-4974-8f56-7a18ebb9a64c",rowsel.SupplieId,"edit");
                    }
                    else{
                        ViewFormComn("022765e2-b49b-4325-9fae-d8b77d9b5169",rowsel.SupplieId,"edit");
                    }
                }
            }
            else{
                Power.ui.warning("未选择供应商");
            }
        }
        //在线询价
        function InquiryOnline(){
            if(IsEmpty(inquiryEndDate)){
                Power.ui.warning("通常-报价截止日期未定义");
                return;
            }
            if(gdMatList.data.length<=0){
                Power.ui.warning("物料明细-未定义");
                return;
            }
            if(gdSupplieList.data.length<=0){
                Power.ui.warning("供应商名单-未定义");
                return;
            }
            var end = gdSupplieList.data.length;
            for(var i =0;i<end;i++)
            {
                var dt = gdSupplieList.data[i];
                if(IsEmpty(dt.InquiryHumanName)){
                    Power.ui.warning("供应商名单-报价人员未定义");
                    return;
                } 
                if(IsEmpty(dt.Email)){
                    Power.ui.warning("供应商名单-EMail地址未定义");
                    return;
                } 
            }

            Power.ui.confirm("审批单将禁止修改，是否继续", function (ret) {
            if (ret) {
                    Power.ui.loading("loading...");
                    //验证通过，开始执行
                    $.ajax({
                        url: "/StoreReport/InquiryOnline",
                        data: {"id":KeyValue},
                        type: "get",
                        // async: false,
                        success: function (text) {
                            Power.ui.loading.close();
                            if(text == 0){
                                Power.ui.warning("已生成在线询价单，禁止重复生成");
                            }
                            else if(text ==1){
                                Power.ui.success("已生成在线询价单[在线询价-"+title.getValue()+"]")
                            }
                            var a = {id: "XLX_PUR_Inquiry.Refresh"};
                            PowerForm.OnBtnRefresh(a);
                        }
                    });
                }
            });
           
        }


        PowerForm.EventAfterFormLoad = function (e) {
            // 别弹框了
            // delete formconfig.config.joindata.oldcurrow;
            //默认隐藏，只有新增状态显示
            inquiryOnline.setVisible(false);
            // if(sta.getValue() == "0")
            // {
            //     inquiryOnline.setVisible(true);
            // }
        };




        //送审前判断子表是否有数据
        PowerForm.EventBeforeOnBtnFlow = function (e)
        {
            e.isValid = true;
            var grid = mini.get("XLX_PUR_Inquiry_MatList");
            if (grid) {
                if (grid.data.length == 0 || grid.data.length == undefined) {
                    Power.ui.alert("无明细内容,请填报后再审批!");
                    e.isValid = false;
                }
                else {
                }
            }
            var gridSupplie = mini.get("XLX_PUR_Inquiry_SupplieList");
            if (gridSupplie) {
                if (gridSupplie.data.length == 0 || gridSupplie.data.length == undefined) {
                    Power.ui.alert("无供应商明细,请填报后发起!");
                    e.isValid = false;
                }
                else {
                }
            }
            if(formconfig.config.joindata.currow.SupplieId == undefined || formconfig.config.joindata.currow.SupplieId == ""){
                    Power.ui.alert("请在[报价明细]里选择唯一的供应商!");
                    e.isValid = false;
            }
            
        }
        function DrawCell(e) {
            var record = e.record;
            if (e.field == "MatCode") {
                e.cellHtml = "<a href='javasrcipt:void(0)' onclick=\"OnViewForm('9963eeb2-03c5-4620-bce4-e09782d27db1', '" + record.Bomfile_Id + "');\">" + e.value + "</a>";
            }
        }
        PowerForm.EventWizardWhere = function (e) {
				//alert(e.id);
				//通过判断向导ID,分别控制向导的尺寸
				if(e.id=='XLX_PUR_Inquiry_MatList.Add')
				{
				//e.iwidth=1000;
				//e.iheight=800;
				 if( formconfig.config.joindata.currow.BuyerId!=null&&
				 formconfig.config.joindata.currow.BuyerId != "00000000-0000-0000-0000-000000000000")
					e.where = " 1=1 and (BuyWay = '03' or BuyWay = '02') and BuyerId='" + formconfig.config.joindata.currow.BuyerId + "'" ;
				}
			}
        function oncellendedit(e) {
            if (e.field == "MatPrice") {//当这个字段编辑结束后，触发以下事件
                var record = e.record;//当前行的数据
                var sender = e.sender;//当前子表对象
                var Price = record.MatPrice == null ? 0 : parseFloat(record.MatPrice);//单价
                var Amount = record.Qty_Inquiry == null ? 0 : parseFloat(record.Qty_Inquiry);//数量
                var MatMoney = Price * Amount;
                sender.updateRow(record, { MatMoney: MatMoney });//修改sender对象的record行的Money列
            }
            if (e.field == "GoodsMatPrice") {//当这个字段编辑结束后，触发以下事件
                var record = e.record;//当前行的数据
                var sender = e.sender;//当前子表对象
                var Price = record.GoodsMatPrice == null ? 0 : parseFloat(record.GoodsMatPrice);//单价
                var Amount = record.Qty_Inquiry == null ? 0 : parseFloat(record.Qty_Inquiry);//数量
                var MatMoney = Price * Amount;
                sender.updateRow(record, { GoodsMatMoney: MatMoney });//修改sender对象的record行的Money列
            }

        }
        function OnViewForm(formid, keyvalue) {
            mini.open({
                url: '/Form/EditForm/' + formid + '/' + keyvalue,
                showMaxButton: true,
                width: 1200,
                height: 600
            })
        }
		function OpenFrom1(id) {
            mini.open({
                url: '/Form/ViewForm/52599d7a-5f45-4ff1-8031-f90b365c6b37/' + id,
                width: 900,
                height: 550
            });

        }
		function OpenFrom2(id) {
            mini.open({
                url: '/Form/ViewForm/52599d7a-5f45-4ff1-8031-f90b365c6b37/' + id,
                width: 900,
                height: 550
            });

        }
        
        function FileUp(keyword, keyvalue) {
            mini.parse();

            if (keyword == "")
                keyword = "XLX_PUR_Inquiry_SupplieList";//此处修改关键词

            if (keyvalue == undefined || keyvalue == "")
                keyvalue = "00000000-0000-0000-0000-000000000000";
            var grid = mini.get("View_XLX_InquirySupplie");//此处修改关键词
            $("#btnUpload").html("");
            $("#btnUpload").uploadify({
                "height": 30,
                width: "56",
                fileSizeLimit: 0,
                auto: true,
                blocksize: 2048 * 500, //分块大小
                "buttonText": "<i class=\"fa fa-retweet\"></i>导入报价",
                "swf": '/Scripts/plugins/uploadify/uploadify.swf',
                "uploader": '/PowerPlat/Control/File.ashx?_type=ftp&action=upload',
                formData: {
                    KeyWord: keyword,
                    KeyValue: keyvalue
                },
                onUploadStart: function () {
                    if (formconfig.FormState == "add") {
                        Power.ui.alert("请先保存主表");
                        return;//新增时，不能导入
                    }
                    grid.loading("上传中，请稍后.....");
                },
                onUploadComplete: function () {
                    grid.loading("导入中,请稍后.....");
                    var exec = {};  //对象
                    exec.KeyWord = "XLX_PUR_Inquiry_SupplieList";   //bo的KeyWord//此处修改关键词
                    exec.MethodName = "ImportExcel"; //方法名称//此处修改方法名称
                    //如果是数据集的话，要加上 exec.KeyWordType="ViewEntity";
                    exec.MethodParams = {}; //方法参数
                    var params = exec.MethodParams;
                    params.KeyWord = keyword;
                    params.KeyValue = keyvalue;
                    params.Id = formconfig.KeyValue;

                    var txt = mini.encode(exec); //对象转换成字符串

                    $.ajax({
                        url: "/API/Exec",
                        type: "POST",
                        data: { jsonData: txt }, //对象字符串传递给 jsonData变量
                        cache: false,
                        success: function (text) {
                            var tmp = mini.decode(text);
                            if (!tmp.success)
                                Power.ui.error(tmp.message);
                            else if (tmp.data.value != "")
                                Power.ui.alert(tmp.data.value);
                            grid.reload();
                        }
                    });
                },
                onDialogClose: function () {
                }
            });
            $(".uploadify-button-text").addClass("btn").addClass("btn-primary");

        }

        PowerForm.EventAfterLoadData = function (e) {
            if (e.sender.id == "XLX_PUR_Inquiry_SupplieList"){
                mini.get("View_XLX_InquirySupplie").reload(); 
			}
			if(e.sender.id == "VIEW_XLX_PUR_Inquiry_MatList"){
			   var grid = mini.get("VIEW_XLX_PUR_Inquiry_MatList");
			   if (e.data && e.data[0].SuppJson) {
			         var company = mini.decode(e.data[0].SuppJson).List;
					 var rowdata;
					 
					 //所有报价项目未税合计
					 //所有报价项目含税合计
					 //拟承做项目含税金额合计
					 
					 rowdata = { MatCode:"税率%"};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] = company[i].TaxRate;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					
					 rowdata = { MatCode:"所有报价项目含税合计：元"};
					 
					  for(var i=0;i<company.length;i++){
					     var TaxPirce = 0
					     for(var k=0;k<e.data.length-1;k++){
						     TaxPirce += parseFloat(e.data[k]["Total"+i]);
						 }  
					     rowdata["One" + i] = TaxPirce;
						 SumTaxPirce.push(TaxPirce);
					  }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"所有报价项目未税合计：元"};
					 for(var i=0;i<company.length;i++){
					    
						var NotTaxRate = parseFloat(company[i].TaxRate)/100 * parseFloat(SumTaxPirce[i])
					    rowdata["One" + i] = parseFloat(SumTaxPirce[i]) - NotTaxRate;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 
					 rowdata = { MatCode:"拟承做项目含税金额合计：元"};
					
					 
					 if(company.length > 1){
					    var  SumZb_Total = 0
					    for(var i=0;i<e.data.length -3;i++){
						   SumZb_Total += parseFloat(e.data[i]["Zb_Total"])
						}
						rowdata["One0"] = SumZb_Total
					 }
					  grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"Invoice 发票类型："};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] = company[i].Invoice;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"币别"};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] = company[i].CurrencyType;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"交货方式"};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] = company[i].Method;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"交期"};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] ="&nbsp;" + company[i].Delivery;
					 }
                     grid.addRow(rowdata, grid.data.length);
                     
                     rowdata = { MatCode:"支付方式"};
					 for(var i=0;i<company.length;i++){
                         var paymentMethod = company[i].PaymentMethod;
                         if(IsEmpty(paymentMethod)){
                            paymentMethod="";
                         }
					    rowdata["One" + i] ="&nbsp;" + paymentMethod;
					 }
                     grid.addRow(rowdata, grid.data.length);
                     
                     rowdata = { MatCode:"结算方式"};
					 for(var i=0;i<company.length;i++){
                         var settlementMethod = company[i].SettlementMethod;
                         if(IsEmpty(settlementMethod)){
                            settlementMethod="";
                         }
					    rowdata["One" + i] ="&nbsp;" + settlementMethod;
					 }
                     grid.addRow(rowdata, grid.data.length);
                     
                     rowdata = { MatCode:"质保金"};
					 for(var i=0;i<company.length;i++){
                         var warrantyAmount = company[i].WarrantyAmount;
                         if(IsEmpty(warrantyAmount)){
                            warrantyAmount=0;
                         }
					    rowdata["One" + i] ="&nbsp;" + warrantyAmount;
					 }
                     grid.addRow(rowdata, grid.data.length);
                     
                     rowdata = { MatCode:"贴息方式"};
					 for(var i=0;i<company.length;i++){
                        var discountMethod = company[i].DiscountMethod;
                         if(IsEmpty(discountMethod)){
                            discountMethod="";
                         }
					    rowdata["One" + i] ="&nbsp;" + discountMethod;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"商务条件"};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] = "&nbsp;"+ company[i].condition;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"保修期"};
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] ="&nbsp;" + company[i].Warranty;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 rowdata = { MatCode:"其他条件"}; 
					 for(var i=0;i<company.length;i++){
					    rowdata["One" + i] = company[i].other;
					 }
					 grid.addRow(rowdata, grid.data.length);
					 
					 
					 //*******合并*******//
                    cells = [
					    { rowIndex: grid.data.length - 11, columnIndex: 1, rowSpan: 0, colSpan: 12 },
					    { rowIndex: grid.data.length - 10, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 9, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 8, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 7, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 6, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 5, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 4, columnIndex: 1, rowSpan: 0, colSpan: 12 },
						{ rowIndex: grid.data.length - 3, columnIndex: 1, rowSpan: 0, colSpan: 12 },
                        { rowIndex: grid.data.length - 2, columnIndex: 1, rowSpan: 0, colSpan: 12 },
                        { rowIndex: grid.data.length - 1, columnIndex: 1, rowSpan: 0, colSpan: 12 }
                    ];
					
					var columnIndexNum = 13
					for(var i=0;i<company.length;i++){
					   var cols = i * 3;
					   cells.push({ rowIndex: grid.data.length - 11, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 10, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 9, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 8, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 7, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 6, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 5, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 4, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 3, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 2, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					   cells.push({ rowIndex: grid.data.length - 1, columnIndex: columnIndexNum + cols, rowSpan: 0, colSpan: 3 })
					}
                    grid.mergeCells(cells);
			   }
			}
        }
        //控制表单中向导的尺寸   



        //分组显示
        function onDrawGroup(e) {
            if(e.field=="MatCode")
            {
                e.cellHtml = "物料编码:"+e.value +"（最低价:"+ getGenderText1(e.value,e.field)+")";
            }

            if(e.field=="Name")
            { 
                var radioHtml = '<input name="1"   type="radio" onclick="check(\'' + e.rows[0].SupplieId + '\',\''+e.rows[0].Name+'\')"';
                var style = "";
                if (formconfig.config.joindata.currow.SupplieId == e.rows[0].SupplieId){
                    radioHtml += ' checked';
                    style = " style=\"color:#008800\"";
                    mini.get("XLX_PUR_Inquiry.TotalPrice").setValue(getGenderText2(e.value, e.field))
                }
                radioHtml += " />";
                e.cellHtml = "<span  " + style + ">供应商:" + e.value + "（报价合计:" + getGenderText(e.value, e.field) + ",议价合计:" + getGenderText3(e.value, e.field) + ") </span>" + radioHtml;
            }
        }
		function onDrawGroup1(e) {
            if(e.field=="MatCode")
            {
                e.cellHtml = "物料编码:"+e.value +"";
            }

            if(e.field=="Name")
            { 
                var radioHtml = '<input name="1"   type="radio" onclick="check(\'' + e.rows[0].SupplieId + '\',\''+e.rows[0].Name+'\')"';
                var style = "";
                if (formconfig.config.joindata.currow.SupplieId == e.rows[0].SupplieId){
                    radioHtml += ' checked';
                    style = " style=\"color:#008800\"";
                    mini.get("XLX_PUR_Inquiry.TotalPrice").setValue(getGenderText(e.value, e.field))
                }
                radioHtml += " />";
                e.cellHtml = "<span  "+style+">供应商:" + e.value + "（报价合计:" + getGenderText(e.value, e.field) + ") </span>" + radioHtml;
            }
		}
		//组合分组报价汇总金额
		function getGenderText2(id, Type) {
		    var grid3 = mini.get("View_XLX_InquirySupplie");
		    var TotalMoney = 0;
		    var MinPrice = 0;
		    var SupplieName = "";
		    var ReturnValue = "";

		    if (Type == "Name") {
		        for (var i = 0; i < grid3.data.length; i++) {
		            if (id == grid3.data[i].Name) {
		                TotalMoney = TotalMoney + parseFloat(grid3.data[i].GoodsMatMoney);
		                TotalMoney = fomatFloat(TotalMoney, 2);
		            }
		        }
		        ReturnValue = TotalMoney;
		    }
		    if (ReturnValue == 0) {
		        for (var i = 0; i < grid3.data.length; i++) {
		            if (id == grid3.data[i].Name) {
		                TotalMoney = TotalMoney + parseFloat(grid3.data[i].MatMoney);
		                TotalMoney = fomatFloat(TotalMoney, 2);
		            }
		        }
		        ReturnValue = TotalMoney;
		    }
		    return ReturnValue;
		}
        //组合分组报价汇总金额
        function getGenderText(id,Type)
        {
            var grid3 = mini.get("View_XLX_InquirySupplie");
            var TotalMoney=0;
            var MinPrice=0;
            var SupplieName="";
            var ReturnValue="";

            if(Type=="MatCode")
            {
                var rows = grid3.findRows(function(row){
                    if(id == row.MatCode) return true;
                });

                for (var i = 0; i < rows.length; i++)
                {
                    if(i==0)
                    {
                        MinPrice=rows[i].MatPrice;
                        SupplieName=rows[i].Name;
                    }
                    if(parseFloat(MinPrice)>parseFloat(rows[i].MatPrice))
                    {
                        MinPrice=rows[i].MatPrice;
                        SupplieName=rows[i].Name;
                    }
                }
                ReturnValue = MinPrice+"--"+SupplieName;
            }

            if(Type=="Name")
            {
                for (var i = 0; i < grid3.data.length; i++)
                {
                    if(id == grid3.data[i].Name)
                    {
                        TotalMoney=TotalMoney+parseFloat(grid3.data[i].MatMoney);
                        TotalMoney = fomatFloat(TotalMoney, 2);
                    }
                }
                ReturnValue = TotalMoney;
            }

            return ReturnValue;
        }
        //组合分组报价汇总金额
        function getGenderText3(id, Type) {
            var grid3 = mini.get("View_XLX_InquirySupplie");
            var TotalMoney = 0;
            var MinPrice = 0;
            var SupplieName = "";
            var ReturnValue = "";

            if (Type == "MatCode") {
                var rows = grid3.findRows(function (row) {
                    if (id == row.MatCode) return true;
                });

                for (var i = 0; i < rows.length; i++) {
                    if (i == 0) {
                        MinPrice = rows[i].MatPrice;
                        SupplieName = rows[i].Name;
                    }
                    if (parseFloat(MinPrice) > parseFloat(rows[i].MatPrice)) {
                        MinPrice = rows[i].MatPrice;
                        SupplieName = rows[i].Name;
                    }
                }
                ReturnValue = MinPrice + "--" + SupplieName;
            }

            if (Type == "Name") {
                for (var i = 0; i < grid3.data.length; i++) {
                    if (id == grid3.data[i].Name) {
                        TotalMoney = TotalMoney + parseFloat(grid3.data[i].GoodsMatMoney);
                        TotalMoney = fomatFloat(TotalMoney, 2);
                    }
                }
                ReturnValue = TotalMoney;
            }

            return ReturnValue;
        }
        function fomatFloat(src, pos) {
            return Math.round(src * Math.pow(10, pos)) / Math.pow(10, pos);
        }
        function check(supid,supname) { 
            if (supid != formconfig.config.joindata.currow.SupplieId) {
                formconfig.config.joindata.currow.SupplieId = supid;
                //formconfig.config.joindata.currow.SupplieName = supname;
                mini.get("XLX_PUR_Inquiry.SupplieName").setValue(supname);
            }
        } 
         //组合分组报价汇总金额
        function getGenderText1(id,Type)
        {
            var grid4 = mini.get("View_XLX_PUR_InquiryMatCode");
            var TotalMoney=0;
            var MinPrice=0;
            var SupplieName="";
            var ReturnValue="";

            if(Type=="MatCode")
            {
                var rows = grid4.findRows(function(row){
                    if(id == row.MatCode) return true;
                });

                for (var i = 0; i < rows.length; i++)
                {
                    if(i==0)
                    {
                        MinPrice=rows[i].MatPrice;
                        SupplieName=rows[i].Name;
                    }
                    if(parseFloat(MinPrice)>parseFloat(rows[i].MatPrice))
                    {
                        MinPrice=rows[i].MatPrice;
                        SupplieName=rows[i].Name;
                    }
                }
                ReturnValue = MinPrice+"--"+SupplieName;
            }
		}
 
        //展开分组
        function PMS_Expand()
        {
            var grid3 = mini.get("View_XLX_InquirySupplie");
            grid3.expandGroups();
        }
        //折叠分组
        function PMS_Collapse()
        {
            var grid3 = mini.get("View_XLX_InquirySupplie");
            grid3.collapseGroups();
        }
		
		//展开分组
        function PMS_Expand1()
        {
            var grid4 = mini.get("View_XLX_PUR_InquiryMatCode");
            grid4.expandGroups();
        }
        //折叠分组
        function PMS_Collapse1()
        {
            var grid4 = mini.get("View_XLX_PUR_InquiryMatCode");
            grid4.collapseGroups();
        }

        //生成采购订单
        function PMS_CreateOrder()
        {
            var InquirySupplie = mini.get("View_XLX_InquirySupplie");
            if (InquirySupplie) {
                if (InquirySupplie.data.length == 0 || InquirySupplie.data.length == undefined) {
                    Power.ui.alert("无供应商询价,请询价后发起!");
                    e.isValid = false;
                }
                else {
                    var SelMatList = $(":radio:checked").map(function(index,elem) {
                        return $(elem).val();
                    }).get().join("#");
                    if(SelMatList !=undefined)
                    {
                        if(confirm("确定生成采购订单吗？"))
                        {
                            var par = {"Type":"发起采购订单","Id":formconfig.KeyValue,"HumanId":HumanId,"HumanName":HumanName,"SupplieId":SelMatList};
                            FormFuns.APIExec("XLX_PUR_Inquiry","BO","Proc_XLX_PUR_Inquiry", par, function(text){
                                var R = mini.decode(text).data.value.split("！");
                                Power.ui.warning(R[0]);
                                if(R[1] != undefined & R[1] !='')
                                {
                                    OpenFrom(R[1]);
                                }
                            });
                        }
                    }
                    else
                    {
                        Power.ui.warning("请选择物料编码！");
                    }
                }
            }

        }
        function PMS_CreateContract() {
            var InquirySupplie = mini.get("View_XLX_InquirySupplie");
            if (InquirySupplie) {
                if (InquirySupplie.data.length == 0 || InquirySupplie.data.length == undefined) {
                    Power.ui.alert("无供应商询价,请询价后发起!");
                    e.isValid = false;
                }
                else {
                    var SelMatList = $(":radio:checked").map(function (index, elem) {
                        return $(elem).val();
                    }).get().join("#");
                   
                    if (SelMatList != undefined) {
                        if (confirm("确定生成采购合同吗？")) {
                           
                            var par = { "Type": "生成采购合同", "Id": formconfig.KeyValue, "HumanId": HumanId, "HumanName": HumanName, "SupplieId": SelMatList };
                            FormFuns.APIExec("XLX_PUR_Inquiry", "BO", "Proc_XLX_PUR_Inquiry", par, function (text) {
                                var R = mini.decode(text).data.value.split("！");
                                Power.ui.alert(R[0]);
                                if (R[1] != undefined & R[1] != '') {
                                    OpenFrom(R[1]);
                                }
                            });
                        }
                    }
                    else {
                        Power.ui.warning("请选择物料编码！");
                    }
                }
            }
        }
        //显示技术规格书表单
        function OpenFrom(id) {
            mini.open({
                url: '/Form/EditForm/a282f668-a395-4a9f-823e-61a2909aa10e/' + id,
                width: 900,
                height: 550
            });
        }
		function AddMat(e) {
            if (e.id == "XLX_PUR_Inquiry_MatList.Add") {
                if (formconfig.FormState == "add") {
                    e.canOpen = false;
                    Power.ui.warning("请先保存主表");
                    return;
                }
            }
            var Grid = mini.get("XLX_PUR_Inquiry_MatList");
            var Fid = formconfig.KeyValue;
            var BuyerId = formconfig.config.joindata.currow["BuyerId"];;
            mini.open({
                url: "/Form/OpenWizardURL?url=/PowerPlat/FormXML/zh-CN/XLX_PUR/Wizard_XLX_PUR_Order22.html&multi=1&Fid=" + Fid+"&BuyerId="+BuyerId,
                showMaxButton: true,
                width: 1200,
                height: 600,
                onload: function () {
                    var iframe = this.getIFrameEl();
                    iframe.contentWindow.WizardParams = { multi: "1" };
                    iframe.contentWindow.Select.LoadStepFirst();
                },
                ondestroy: function (action) {
                    //debugger;
                    if (action != "ok")
                        return;
                    var iframe = this.getIFrameEl();
                    var data = iframe.contentWindow.Select.GetData();
                    if (!data || data.length == 0) {
                        Power.ui.warning(app_global_ResouceId["not_select_data"]); //未选择数据
                        return;
                    }
                    data = mini.clone(data);
                    for (var i = 0; i < data.length; i++) {
                        var row = {};
                        row.Id = CreateGUID();
                        row.FK = formconfig.KeyValue;
                        row.MatBS_Guid = data[i].MatBS_Guid;
                        row.MatBS_Name = data[i].MatBS_Name;
						row.MatBS_Code = data[i].MatBS_Code;
                        row.RequestList_Id = data[i].ListId;
                        row.MatId = data[i].MatId;
                        row.MatCode = data[i].MatCode;
                        row.MatName = data[i].MatName;
						row.Model = data[i].Model;
                        row.Qty_Request = data[i].Qty_Req;
						row.Specifi = data[i].Specifi;
						row.Standard = data[i].Standard;
						row.Texture = data[i].Texture;
						row.Pattern = data[i].Pattern;
						row.MatSpec = data[i].DeviceName;
						row.TagNumber = data[i].UnitName;
                        row.Qty_Inquiry = data[i].Qty_Req;
						row.InquiryUnit = data[i].MatUnit;
						row.MatUnit = data[i].MatUnit;
						row.Remark = data[i].Remark;
                        row.RequestCode = data[i].RequestCode;
                        row.Request_Id = data[i].MainId;						
						row.RequestHumId = "";
						row.RequestHumName = "";
						row.Bomfile_Id = data[i].Bomfile_Id;
                        Grid.addRow(row, 0)
                    }
                    var a = { id: "XLX_PUR_Inquiry.Save" };
                    PowerForm.OnBtnSave(a);
                }
            })
		}

		$("#btnSave").click(function () {
		    Save();
		});
		function Save(fnback) {

		    var rows = mini.get("View_XLX_InquirySupplie").getChanges(null, false); //获取所有修改行及其字段
		    if (!rows || rows.length == 0) {
		        if (fnback) fnback(true);//【Ronnie】?干什么用
		    }
		   
		    else {
		        for (var i = 0; rows.length > i; i++) {
		            var ListId = rows[i].ListId; //主键
		            var MatMoney = rows[i].MatMoney;//报价
		            var MatPrice = rows[i].MatPrice;//报价总额
		            var GoodsMatMoney = rows[i].GoodsMatMoney;//议价
		            var GoodsMatPrice = rows[i].GoodsMatPrice;//议价总额
		            var Remark = rows[i].Remark;//报价明细备注

		            var P = { "ListId": ListId, "MatMoney": MatMoney, "MatPrice": MatPrice, "GoodsMatMoney": GoodsMatMoney, "GoodsMatPrice": GoodsMatPrice, "Remark": Remark };
		            FormFuns.APIExec("XLX_PUR_InquirySupplie", "BO", "UpdateSupplieList", P, function (text) {
		                var R = mini.decode(text).data.value;
		              
		            });
		        }
		        mini.get("XLX_PUR_Inquiry.Refresh").doClick();
		    }
		}
        
		PowerForm.EventBeforeRenderData = function (e, data) {
		   if (e.sender.id == "VIEW_XLX_PUR_Inquiry_MatList") {
		       var columns = [];
                columns.push({ field: "indexcolumn", width: 50, headerAlign: "center", align: "center", allowSort: false, header: "序号" });
                columns.push({ field: "MatCode", width: 100, headerAlign: "center", align: "center", allowSort: false, header: "物资编码" });
                columns.push({ field: "MatName", width: 100, headerAlign: "center", align: "left", allowSort: false, header: "物资名称" });
                columns.push({ field: "Model", width: 100, headerAlign: "center", align: "left", allowSort: false, header: "型号规格" });
                columns.push({ field: "Qty_Inquiry", width: 80, headerAlign: "center", align: "center", allowSort: false,numberFormat:"n2", header: "数量" });
                columns.push({ field: "MatUnit", width: 50, headerAlign: "center", align: "center", allowSort: false, header: "单位" });
				
				var columns1 = [];
				columns1.push({ field: "PlanDate", width: 100, headerAlign: "center", align: "center", dateFormat:"yyyy-MM-dd", allowSort: false, header: "订购时间" });
				columns1.push({ field: "PartyB", width: 150, headerAlign: "center", align: "center", allowSort: false, header: "供应商" });
				columns1.push({ field: "MatPrice",  headerAlign: "center", align: "center", allowSort: false, header: "单价" });
				columns.push({ columns: columns1,  headerAlign: "center",align: "center", allowSort: false, header: "前批价格信息"});
				
				var columns2 = [];
				columns2.push({ field: "Zb_PartyB",width: 150,  headerAlign: "center", align: "center", allowSort: false, header: "供应商" });
				columns2.push({ field: "Zb_MatPrice",  headerAlign: "center", align: "center", allowSort: false,numberFormat:"n2", header: "单价" });
				columns2.push({ field: "Zb_Num",  headerAlign: "center", align: "right", allowSort: false,numberFormat:"n2", header: "数量" });
				columns2.push({ field: "Zb_Total",  headerAlign: "center", align: "right", allowSort: false,numberFormat:"n2", header: "小计" });
				columns.push({ columns: columns2,  headerAlign: "center", align: "center", allowSort: false, header: "拟中标信息"});
				
				//供应商
				if (data != "" && data[0].SuppJson != null) {
				
				 for (var i=0;i<data.length; i ++){
				        var d = data[i];
						d["indexcolumn"] = i+ 1;
				        var company = mini.decode(d.SuppJson).List;
						for (var j = 0;j <company.length;j++){
						   
						   d["One" + j] =company[j].MatPrice;
						   d["two" + j] =company[j].GoodsMatPrice;
						   d["Total" + j] =company[j].TotalPrice;
						   if(i==0){
							   var columns3 = [];
							   columns3.push({ field: "One" + j,  headerAlign: "center", align: "right", allowSort: false, numberFormat:"n2", header: "报价" });
							   columns3.push({ field: "two" + j, headerAlign: "center", align: "right", allowSort: false,numberFormat:"n2", header: "议价" });
							   columns3.push({ field: "Total" + j,  headerAlign: "center", align: "right", allowSort: false,numberFormat:"n2", header: "合计" });
							   columns.push({ columns: columns3, headerAlign: "center", align: "center", allowSort: false, header: company[j]["SupplieName"]});
						   }
						}					
				    }				
				}
				mini.get("VIEW_XLX_PUR_Inquiry_MatList").set({
                        columns: columns
                });
		   }
		   return data;
		}
		
    </script>
</body>
</html>
