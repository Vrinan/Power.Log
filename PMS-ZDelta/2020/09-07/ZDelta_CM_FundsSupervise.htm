<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <script src="/Scripts/boot.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/ComTools.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/WebForm.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Form/Init/$Model.data.FormId/$Model.data.FormState/$Model.data.KeyValue"></script>
    <script language="javascript" src="/Scripts/PlatForm/ControlCenter.js?v=$AppVersion"></script>
    <script language="javascript" src="/Scripts/PlatForm/WorkFlowsEnums.js?v=$AppVersion"></script>
    <script language="javascript" src="/Scripts/PlatForm/WorkFlowsFormVue.js?v=$AppVersion"></script>
    <link href="/Scripts/plugins/uploadify/uploadify.css?v=$AppVersion" rel="stylesheet" type="text/css" />
    <script src="/Scripts/plugins/uploadify/jquery.uploadify.html5.js?v=$AppVersion" type="text/javascript"></script>
    <script type="text/javascript" hasvelocity="true">
        var KeyValue = "$Model.data.KeyValue"
        var FormId = "$Model.data.FormId"
        var FormState = "$Model.data.FormState"
    </script>
</head>

<body>
    <div class="row" style="height: 100%">
        <div class="portlet box" style="height: 100%">
            <!--标准按钮-->
            <div class="portlet-title bottom">
                <div class="caption">
                    <i class="fa fa-reorder"></i>监管资金划拨
                </div>
                $!WorkFlowButtons
                <div class="actions">
                    <a class="mini-button blue" id="ZDelta_CM_FundsSupervise.ViewContract" onclick="ViewForm('2e2723c3-7719-4dcf-aef2-7871b5ce62ce',currow.ContractId)">
                        <i class="fa fa-eye"></i>查看合同</a>
                    <div id="btnPrint" class="btn-group"></div>
                    <a class="mini-button blue" id="ZDelta_CM_FundsSupervise.Save" onclick="CustomSave()">
                        <i class="fa fa-save"></i>保存</a>
                    <a class="mini-button blue" id="ZDelta_CM_FundsSupervise.CloseForm" onclick="PowerForm.OnBtnCloseForm(this)">
                        <i class="fa fa-power-off"></i>关闭</a>
                </div>
            </div>
            <div class="mini-fit scroll">
                <div class="portlet-body" style="height: 100%;">
                    <div class="section">
                        <div class="section-title">
                            <div class="lefttools" onclick="ShowHide(this,'tb0')" style="cursor:pointer;">
                                <i class="fa fa-folder-open"></i>基本信息
                            </div>
                        </div>
                        <div class="section-content section-content-info" id="tb0">
                            <div id="ZDelta_CM_FundsSupervise" name="ZDelta_CM_FundsSupervise" class="form">
                                <table id="ZDelta_CM_FundsSupervise_table" class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">编号</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.Code" name="Code" readOnly class="design mini-textbox" />
                                            </td>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">状态</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.Status" name="Status" readonly class="design mini-combobox" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status" required>标题</label>
                                            </td>
                                            <td class="cell td-ctrl" colspan="3">
                                                <input id="ZDelta_CM_FundsSupervise.Title" name="Title" required class="design mini-textbox" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">合同编号</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.ContractCode" readonly name="ContractCode" class="design mini-textbox" />
                                            </td>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">合同名称</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.ContractName" readonly name="ContractName" class="design mini-textbox" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">承包单位名称</label>
                                            </td>
                                            <td class="cell td-ctrl" id="PartyBTd">
                                                <input id="ZDelta_CM_FundsSupervise.PartyBName" readonly name="PartyBName" class="design mini-textbox" />
                                            </td>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">划拨类型</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.TransferType" name="TransferType" class="design mini-combobox" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">开户行</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.BankName" readonly name="BankName" class="design mini-textbox" />
                                            </td>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">账号</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.BankAccount" name="BankAccount" allowInput="false" valueFromSelect="true" textField="Account" valueField="Account" class="design mini-combobox" />
                                                <!-- <input id="ZDelta_CM_FundsSupervise.BankAccount" readonly name="BankAccount" class="design mini-textbox" /> -->
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">账户余额(元)</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.AccountBalance" readonly name="AccountBalance" changeOnMouseWheel="false" minValue="-9999999999"
                                                    maxValue="9999999999" class="design mini-spinner"  format="n2"/>
                                            </td>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">划拨总金额(元)</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.TotalAmount" readonly name="TotalAmount" changeOnMouseWheel="false" minValue="-9999999999"
                                                    maxValue="9999999999" class="design mini-spinner" format="n2" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_Status">联系电话</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.LinkerPhoneNumber" name="LinkerPhoneNumber" class="design mini-textbox" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_RegHumName">录入人</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.RegHumName" name="RegHumName" readonly class="design mini-textbox" />
                                            </td>
                                            <td class="cell td-label">
                                                <label class="design mini-powerlabel" id="lbl_RegDate">录入日期</label>
                                            </td>
                                            <td class="cell td-ctrl">
                                                <input id="ZDelta_CM_FundsSupervise.RegDate" name="RegDate" readonly class="design mini-datepicker" timeformat="yyyy-MM-dd"
                                                />
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="section" title="资金划拨单位" id="ZDelta_CM_FundsSuperviseDtl" name="ZDelta_CM_FundsSuperviseDtl">
                        <div class="section-title">
                            <div class="lefttools" onclick="ShowHide(this,'tb1')" style="cursor:pointer;">
                                <i class="fa fa-folder-open"></i>资金划拨单位
                            </div>
                        </div>
                        <div class="section-content section-content-info" id="tb1">
                            <div class="mini-toolbar">
                                <a class="mini-button blue" iconcls="fa-plus" id="ZDelta_CM_FundsSuperviseDtl.Add0" onclick="PowerForm.OnBtnWizard(this)">新增</a>
                                <a class="mini-button blue" iconcls="fa-trash-o" id="ZDelta_CM_FundsSuperviseDtl.Del" onclick="PowerForm.OnBtnDel(this)">删除</a>
                                <a class="mini-button blue" iconcls="fa-arrow-up" id="ZDelta_CM_FundsSuperviseDtl.MoveUp" onclick="PowerForm.OnBtnMoveUp(this)">上移</a>
                                <a class="mini-button blue" iconcls="fa-arrow-down" id="ZDelta_CM_FundsSuperviseDtl.MoveDown" onclick="PowerForm.OnBtnMoveDown(this)">下移</a>
                            </div>
                            <div id="ZDelta_CM_FundsSuperviseDtl" class="mini-datagrid" style="width: 100%; height: 400px;" allowresize="true" sortField="Sequ" allowAlternating="true"
                                multiSelect="true" allowcellselect="true" allowcelledit="true" pageSize="20" sortField="Sequ"
                                sortOrder="asc" showPager="true" data-options="{canImport:true}">
                                <div property="columns">
                                    <div type="checkcolumn"></div>
                                    <div type="indexcolumn" width="40" header="序号" headerAlgin="center"></div>
                                    <div field="UnitName" name="UnitName" header="收款单位" width="150" headeralign="center" align="left"></div>
                                    <div field="BankName" name="BankName" header="开户行" width="100" headeralign="center" align="left"></div>
                                    <div type="comboboxcolumn" field="BankAccount" name="BankAccount" header="开户账号" width="150" headeralign="center" align="left">
                                        <input property="editor" textField="Account" valueField="Account" valueFromSelect="true" allowInput="false" class="mini-combobox"/>
                                    </div>
                                    <div field="Amount" name="Amount" header="金额(元)" width="80" headeralign="center" align="right" numberFormat="n2">
                                        <input property="editor" class="mini-spinner" changeOnMouseWheel="false" minValue="-9999999999" maxValue="9999999999" style="width:100%;"
                                        />
                                    </div>
                                    <div field="Uses" name="Uses" header="用途" width="100" headeralign="center" align="left">
                                        <input property="editor" class="mini-textbox" style="width:100%;" />
                                    </div>
                                    <div filed="FileName" name="FileName" header="附件" headeralign="center" width="250" renderer="FixedFiles.FileColumnRenderer"></div>
                                    <div type="checkboxcolumn" field="IsApprove" name="IsApprove" header="是否同意支付" headerAlign="center" truevalue="1" falsevalue="0" width="60"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-title">
                            <div class="lefttools" onclick="ShowHide(this,'tb3')" style="cursor:pointer;"><i class="fa fa-folder-open"></i>附件</div>
                        </div>
                        <div class="section-content" id="tb3">
                            <iframe id="attachfile" style="height:100%;width:100%;"  frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="section" id="WorkFlowSection" style="display: none;">
                        <div class="section-title">
                            <div class="lefttools" onclick="ShowHide(this,'tb5')" style="cursor:pointer;"><i class="fa fa-folder-open"></i>流程</div>
                        </div>
                        <div class="section-content" id="tb5" style="height:400px;">
                            <iframe id="workflow" style="height:100%;width:100%;" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="section" id="div_workflowInfo">
                        <div class="section-title">
                            <div class="lefttools" onclick="ShowHide(this,'tb8')" style="cursor:pointer;"><i class="fa fa-folder-open"></i>流程处理</div>
                        </div>
                        <div class="section-content notool" id="tb8" style="height:600px;">
                            <div id="workflowInfo" class="mini-panel" style="height:100%;width:100%; padding-top:0px !important;" showHeader="false"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var PowerForm = new WebForm();
        $(function () {
            PowerForm.Init();
        });
        mini.parse();


        /********************************************开始：变量定义********************************************/

        var currow = null; //当前表单数据
        var dtlGrid = mini.get("ZDelta_CM_FundsSuperviseDtl"); //明细表格
        var bankName = mini.get("ZDelta_CM_FundsSupervise.BankName"); //开户行
        var bankAccount = mini.get("ZDelta_CM_FundsSupervise.BankAccount"); //银行账号
        var accountBalance = mini.get("ZDelta_CM_FundsSupervise.AccountBalance"); //余额
        var linkerPhoneNumber = mini.get("ZDelta_CM_FundsSupervise.LinkerPhoneNumber"); //联系人电话
        var regHumName = mini.get("ZDelta_CM_FundsSupervise.RegHumName"); //联系人
        var partyBCmbText = '<input id="ZDelta_CM_FundsSupervise.PartyBId" name="PartyBId" allowInput="false" valueField="Id" textField="Name" class="design mini-combobox" />';
        var partyBText = '<input id="ZDelta_CM_FundsSupervise.PartyBName" name="PartyBName" readOnly class="design mini-textbox" />';
        var partyBName = null;
        var TransferType = mini.get("ZDelta_CM_FundsSupervise.TransferType");//划拨类型
        var WFRight={"ZDelta_CM_FundsSupervise":[{"BookMarkCode":"Human","Btn":["Save"]}],"ZDelta_CM_FundsSuperviseDtl":[{"BookMarkCode":"Human","Btn":["Add0","Del","MoveUp","MoveDown"],"Column":["IsApprove"]}]};

        /********************************************结束：变量定义********************************************/

        /********************************************开始：平台事件重写********************************************/

        //表单加载后事件
        PowerForm.EventAfterFormLoad = function (e, data) {
            currow = formconfig.config.joindata.currow;
            FormLoadCommomMethod(e, data);
            if (FormState == 'add') {
                //联合体，乙方单位要可选
                if(currow.IsConsortium){
                    var cmbData = [];
                    cmbData.push({"Id":currow.PartyBId,"Name":currow.PartyBName});
                    var array = ["C","D","E","F","G","H","I","J","K"];
                    var index = 0;
                    if(IsEmpty(currow.PartyCId))
                        index = 1;
                    else if(IsEmpty(currow.PartyDId))
                        index = 2;
                    else if(IsEmpty(currow.PartyEId))
                        index = 3;
                    else if(IsEmpty(currow.PartyFId))
                        index = 4;
                    else if(IsEmpty(currow.PartyGId))
                        index = 5;
                    else if(IsEmpty(currow.PartyHId))
                        index = 6;
                    else if(IsEmpty(currow.PartyIId))
                        index = 7;
                    else if(IsEmpty(currow.PartyJId))
                        index = 8;
                    else if(IsEmpty(currow.PartyKId))
                        index = 9;
                    for(var i = 0; i < index - 1; i ++){
                        eval('cmbData.push({"Id":currow.Party' + array[i] + 'Id,"Name":currow.Party' + array[i] + 'Name});');                        
                    }
                    $("#PartyBTd").html(partyBCmbText);
                    mini.parse();
                    mini.get("ZDelta_CM_FundsSupervise.PartyBId").setData(cmbData);
                    mini.get("ZDelta_CM_FundsSupervise.PartyBId").setValue(currow.PartyBId);
                    mini.get("ZDelta_CM_FundsSupervise.PartyBId").on("valuechanged",function(e){
                        currow.PartyBName = e.selected.Name;
                        currow.PartyBId = e.selected.Id;
                        GetBankInfo();
                    });
                }
                currow.BankJson = "[]";
                GetBankInfo();
            } else {
                
                if(mini.get("ZDelta_CM_FundsSupervise.PartyBId")){
                    $("#PartyBTd").html(partyBText);
                    mini.parse();
                    mini.get("ZDelta_CM_FundsSupervise.PartyBName").setValue(currow.PartyBName);
                }

                dtlGrid.getColumn("BankAccount").editor.data = mini.decode(currow.BankJson);
                bankAccount.setData(mini.decode(currow.BankInfo));
                bankAccount.setValue(currow.BankAccount);
            }
            FixedFiles.FormInit(null,"ZDelta_CM_FundsSuperviseDtl",null,dtlGrid.id);
        }

        PowerForm.EventBeforeRenderData = function(e,data){
            if(e.sender.id == dtlGrid.id){
                var config = formconfig.config.joindata;
                if(data.length > 0){
                    var idStr = "";
                    data.forEach(function(item){
                        idStr += "'" + item.Id  + "',";
                    });
                    idStr = idStr.substring(0,idStr.length - 1);
                    FixedFiles.LoadFiles("ZDelta_CM_FundsSuperviseDtl",idStr,function(docFiles){
                        docFiles.forEach(function(item){
                            for(var i = 0; i < data.length; i ++){
                                if(item.FolderId == data[i]["Id"]){
                                    data[i]["FileName"] = item.Name;
                                    data[i]["FileId"] = item.Id;
                                    data[i]["FileExt"] = item.FileExt;
                                }
                            }
                        });
                    });
                }
            }
            return data;
        }

        //保存，服务器返回成功后
        PowerForm.EventAfterOnBtnSave = function(e){
            if(e.id == "ZDelta_CM_FundsSuperviseDtl.Del" || e.id == "ZDelta_CM_FundsSuperviseDtl"){
                PowerForm.OnBtnRefresh({id:"ZDelta_CM_FundsSupervise.xxx"});
            }
        }

        /********************************************结束：平台事件重写********************************************/

        /********************************************开始：miniui拦截事件********************************************/

        dtlGrid.on("cellbeginedit",function(e){
            var record = e.record;
            if (e.field == "BankAccount") {
                var editor = e.editor;
                editor.setData(record.BankJson);
            }
        })

        bankAccount.on("valuechanged",function(e){
            if(e.selected)
                bankName.setValue(e.selected.Name);
        })

        //变更方式下拉框值改变
        TransferType.on("valuechanged",function(e){
            //重新生成编号
            currow.Code = "";
            currow.TransferType = e.value;
            FormFuns.LoadCode(formconfig.config.joindata,new mini.Form("#ZDelta_CM_FundsSupervise"));
        });

        dtlGrid.getCellEditor("BankAccount").on("valuechanged", function (e) {
            dtlGrid.updateRow(dtlGrid.getSelected(),{"BankName":e.selected.Name});
        })
        /********************************************结束：miniui拦截事件********************************************/

        /********************************************开始：自定义事件********************************************/

        //获取银行信息
        var GetBankInfo = function(){
            var loadingInfo = "查询中...";
            bankName.setValue(loadingInfo);
            bankAccount.setValue(loadingInfo);
            accountBalance.setValue(loadingInfo);
            linkerPhoneNumber.setValue(loadingInfo);
            regHumName.setValue(loadingInfo);
            //执行后台方法
            var params = {};
            params.contractId = currow.ContractId;
            params.partyBId = currow.PartyBId;
            FormFuns.APIExec("ZDelta_CM_FundsSupervise", "BO", "GetBankInfo", params, function (text) {
                var tmp = mini.decode(text);
                if (tmp.success) {
                    tmp = mini.decode(tmp.data.value);
                    // bankName.setValue(tmp.BankName == undefined ? "" : tmp.BankName);
                    // bankAccount.setValue(tmp.BankAccount == undefined ? "" : tmp.BankAccount);
                    var bankInfo = mini.decode(tmp.BankInfo);
                    currow.BankInfo = tmp.BankInfo;
                    bankAccount.setData(bankInfo);
                    if(bankInfo.length > 0){
                        bankAccount.setValue(bankInfo[0]["Account"]);
                        bankName.setValue(bankInfo[0]["Name"]);
                    }
                    accountBalance.setValue(tmp.AccountBalance == undefined ? "" : tmp.AccountBalance);
                    linkerPhoneNumber.setValue(tmp.LinkerPhoneNumber == undefined ? "" : tmp.LinkerPhoneNumber);
                    regHumName.setValue(tmp.Linker == undefined ? "" : tmp.Linker);
                } else
                    Power.ui.error(tmp.message);
            });
        }

        //自定义保存按钮
        var CustomSave = function(){
            if(FormState == "add" && currow.IsConsortium){
                //先弹出确认框
                var buttonOption = {};
                var yes = "是",
                    no = "否";
                buttonOption[yes] = {
                    theme: 'primary',
                    handler: function (ret) {
                        if (ret) {
                            PowerForm.OnBtnSave({"id": "ZDelta_CM_FundsSupervise.Save"});
                        }
                    }
                };
                buttonOption[no] = function () {};
                var info = "当前合同为联合体类型，乙方单位为[" + mini.get("ZDelta_CM_FundsSupervise.PartyBId").getText() + "],请确认乙方单位是否正确，确认保存后，乙方单位不可再更改！";
                Power.ui.confirm(info, {
                    button: buttonOption
                });
            }else{
                PowerForm.OnBtnSave({"id": "ZDelta_CM_FundsSupervise.Save"});
            }
        }

        /********************************************结束：自定义事件********************************************/
    </script>
</body>

</html>
