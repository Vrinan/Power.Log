<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <title>项目管理 </title>
    <link href="../global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="../global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css" />
    <link href="../global/plugins/icon-font-alibaba/iconfont.css" rel="stylesheet" type="text/css" />
    <link href="../global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="../global/plugins/slider-pro-master/css/slider-pro.min.css" type="text/css">
    <link rel="stylesheet" href="../global/css/common.css" type="text/css">
    <link rel="stylesheet" href="../global/css/moreColumns.css" type="text/css">

    <script src="/Apps/boot.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/ComTools.js?v=$AppVersion" type="text/javascript"></script>
    <script src="/Apps/js/MobileSingleForm.js?v=$AppVersion" type="text/javascript"></script>

    <!--平台中的JS-->
    <script src="/Scripts/PlatForm/ComTools.js"></script>
    <script src="/Apps/js/MobileSingleForm.js?v=73" type="text/javascript"></script>
    <script src="/Apps/Common.js"></script>
    <!--获取菜单数据 方法 _menulist -->
    <script src="/WebCenter/MenuEpsJson/menu" type="text/javascript"></script>
</head>

<body>

    <!--项目集轮播 -- 开始 -->
    <section class="project-slider-box">
        <div id="projectUnitSlider" class="slider-pro project-top-size">
            <div class="sp-slides" id="sliderUnitContent">

                <div class="sp-slide">
                    <div class="project-slider-unit-content">
                        <div id="projectProgress" data-name="企业在建项目" data-type="Project" ><!--class="project-silder-unit"-->

                            <img src="../global/img/bg.png" class="  project-silder-unit" alt="">
                            <div class="project-slider-unit-title-box">
                                <div class="project-slider-unit-title project-slider-unit-title-new">
                                    企业在建项目个数
                                </div>

                                <div class="project-slider-unit-number project-slider-unit-number-new">
                                    <span>总数：</span><span id="UnderConstruction"></span>
                                </div>
                                <div class=" project-slider-unit-number-detail project-slider-unit-number-detail-new ">
                                    <span>正常</span>：<span id="normal_num">  </span>&nbsp;
                                    <span>滞后</span>：<span id="lag_num">  </span>
                                </div>

                                <div class="project-slider-unit-footer-new">
                                    <a href="" class="project-footer">查看详情<i class="icon iconfont icon-more">  </i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sp-slide">
                    <div class="project-slider-unit-content">
                        <div id="coordinationProblems" data-name="待协调问题" data-type="problem">
                            <img src="../global/img/bg.png" class="  project-silder-unit" alt="">
                            <div class="project-slider-unit-title-box">
                                <div class="project-slider-unit-title project-slider-unit-title-new">
                                    待协调问题个数
                                </div>

                                <div class="project-slider-unit-number project-slider-unit-number-new">
                                    <span>总数：</span><span id="problemAll">0</span>
                                </div>

                                <div class=" project-slider-unit-number-detail project-slider-unit-number-detail-new ">
                                    <span>中等</span>：<span id="medium_num">  </span>&nbsp;
                                    <span>一般</span>：<span id="ordinary_num">  </span>&nbsp;
                                    <span>严重</span>：<span id="serious_num">  </span>
                                </div>

                                <div class="project-slider-unit-footer-new">
                                    <a href="" class="project-footer">查看详情<i class="icon iconfont icon-more">  </i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sp-slide">
                    <div class="project-slider-unit-content" data-id="' + list.Id + '">

                        <img src="../global/img/bg.png" class="  project-silder-unit" alt="">
                            <div class="project-slider-unit-title-box">
                                <div class="project-slider-unit-title project-slider-unit-title-new">
                                    我的任务个数
                                </div>

                                <div class="project-slider-unit-number project-slider-unit-number-new">
                                    <span>总数：</span><span></span>
                                </div>

                                <div class=" project-slider-unit-number-detail project-slider-unit-number-detail-new ">
                                    <span>完成</span>:<span>  </span>&nbsp;
                                    <span>进行中</span>:<span>  </span>&nbsp;
                                    <span>滞后</span>:<span>  </span>
                                </div>

                                <div class="project-slider-unit-footer-new">
                                    <a href="" class="project-footer">查看详情<i class="icon iconfont icon-more">  </i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <!--项目集轮播 -- 结束 -->


    <!--Echarts图 -- 开始 -->
    <section class="project-management-body">
        <div class="container">
            <div class="row">
                <div class="project-module-title">
                    <a class="project-module-title-left">
                        <div class="title-color title-red"></div>
                        <span class="title-fonts">
                                 项目统计状态
                             </span>
                    </a>

                    <a class="project-module-title-right">

                    </a>
                </div>
                <div class="project-management-detail-content clearFix">
                    <div class="project-management-detail-unit">
                        <div id="directAccess1" class="chart-content">
                            数据加载错误
                        </div>
                    </div>


                </div>

                <div class="part-interval"></div>

                <div class="project-module-title">
                    <a class="project-module-title-left">
                        <div class="title-color title-red"></div>
                        <span class="title-fonts">
                                 散点图
                        </span>
                    </a>

                    <a class="project-module-title-right">
                    </a>
                </div>
                <div class="project-management-detail-content clearFix">
                    <div class="project-management-detail-unit">
                        <div id="scatterDiagram1" class="chart-content">
                            数据加载错误
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>
    <!--Echarts图 -- 结束 -->


    <script src="/Apps/Apps2.0/assets/global/plugins/jquery.min.js" type="text/javascript"></script>
    <script src="/Apps/Apps2.0/assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/Apps/Apps2.0/assets/global/plugins/slider-pro-master/js/jquery.sliderPro.min.js" type="text/javascript"></script>
    <script src="/Apps/Apps2.0/assets/global/plugins/echarts/echarts-all.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function() {
            var projectManagement = {
                init: function() {
                    this.events();
                    this.GetSession();
                },
                //准对企业在建项目个数
                projectProgress: function(EpsProjLongCode) {

                    var p = {
                        KeyWord: "V_PS_EPM_ProjectList",
                        KeyWordType: "ViewEntity",
                        index: "0",
                        size: "0"
                    };
                    p.swhere = "1=1 and (LongCode='" + EpsProjLongCode + "' or LongCode like '" +
                        EpsProjLongCode + ".%')";

                    FormFuns.GridPageLoad(p, function(rlt) {
                        if (!rlt.success) {
                            Power.ui.alert(rlt.message);
                            return;
                        }
                        var rs = mini.decode(rlt.data.value);
                        var zh = 0,
                            zc = 0;
                        for (var i = 0; i < rs.length; i++) {
                            var d = rs[i];
                            var act = d.act_complete_pct.toFixed(2);
                            var pln = d.plan_complete_pct.toFixed(2);
                            if (act < pln)
                                zh++;
                            else
                                zc++;

                        }

                        $("#UnderConstruction").text(rs.length);
                        $("#normal_num").text(zc);
                        $("#lag_num").text(zh);

                    });



                },

                //针对待协调问题个数
                coordinationProblems: function(EpsProjLongCode) {
                    var p = {
                        KeyWord: "PS_ProjectIssue",
                        index: "0",
                        size: "0"
                    };
                    p.swhere = "IssueStatus<>'03' and  EpsProjId in ( select project_guid  from pln_project  where LongCode='" +
                        EpsProjLongCode + "' or LongCode like '" + EpsProjLongCode + ".%' )";

                    FormFuns.GridPageLoad(p, function(rlt) {
                        var rs = mini.decode(rlt.data.value),
                            ordinary_num = 0, //一般
                            medium_num = 0, //中等
                            serious_num = 0; //严重

                        if (!rlt.success) {
                            console.log(rlt.message);
                            return;
                        }

                        for (var i = 0; i < rs.length; i++) {
                            var d = rs[i];
                            if (d.IssueLevel == "1") {
                                ordinary_num++;
                            }
                            if (d.IssueLevel == "2") {
                                medium_num++;
                            }
                            if (d.IssueLevel == "3") {
                                serious_num++;
                            }
                        }
                        $("#problemAll").text(rs.length);
                        $("#ordinary_num").text(ordinary_num);
                        $("#medium_num").text(medium_num);
                        $("#serious_num").text(serious_num);
                    })
                },

                //项目状态统计 图表视图
                ItemStatusStatistics: function(longcode) {
                    var p = {
                            KeyWord: "V_PS_EPM_ProjectList",
                            KeyWordType: "ViewEntity",
                            index: "0",
                            size: "0"
                        },
                        data;
                    p.swhere = "1=1 and (LongCode='" + longcode + "' or LongCode like '" + longcode + ".%')";
                    FormFuns.GridPageLoad(p, function(rlt) {
                        if (!rlt.success) {
                            Power.ui.alert(rlt.message);
                            return;
                        }
                        data = mini.decode(rlt.data.value);

                        var yz = 0,
                            zh = 0,
                            cq = 0,
                            zc = 0;
                        for (var i = 0; i < data.length; i++) {
                            var d = data[i];
                            var act = d.act_complete_pct.toFixed(2);
                            var pln = d.plan_complete_pct.toFixed(2);
                            if (act - pln >= 0)
                                cq++;
                            else if (pln - act > 0 && pln - act <= 5)
                                zc++;
                            else if (10 >= pln - act > 5)
                                zh++;
                            else if (pln - act > 10)
                                yz++
                        }


                        var myOption = {
                            tooltip: {
                                show: false,
                                formatter: "{a} <br/>{b} : {c} ({d}%)"
                            },
                            legend: {
                                orient: 'vertical',
                                x: 'left',
                                y: 'center',
                                data: ['正常数量', '超前数量', '滞后数量', '严重滞后']
                            },

                            calculable: false,
                            color: ['#3AA45A', '#496BCD', '#FFC511', '#F1322A'],
                            series: [{
                                name: '项目状态',
                                type: 'pie',
                                center: ['65%', '50%'],
                                radius: 80,
                                itemStyle: {
                                    normal: {
                                        label: {
                                            position: 'inner',
                                            formatter: function(params) {
                                                //显示百分比
                                                // return (params.percent - 0).toFixed(0) + '%'

                                                //显示数值 目前显示是数值  如果显示百分比可以使用上面的方法
                                                return params.value;
                                            }
                                        },
                                        labelLine: {
                                            show: false
                                        }
                                    },
                                    emphasis: {
                                        label: {
                                            show: true,
                                            formatter: "{b}\n{d}%"
                                        }
                                    }
                                },
                                data: [{
                                    value: zc,
                                    name: '正常数量'
                                }, {
                                    value: cq,
                                    name: '超前数量'
                                }, {
                                    value: zh,
                                    name: '滞后数量'
                                }, {
                                    value: yz,
                                    name: '严重滞后'
                                }]
                            }]
                        };



                        var directAccess1 = echarts.init(document.getElementById("directAccess1"));
                        directAccess1.setOption(myOption);

                        window.addEventListener("resize", function() {
                            directAccess1.resize();
                        });
                    });

                },

                //散点图  计划和实际  图表视图
                scatterDiagram: function(currenttask) {

                    function LoadChart(datas) {
                        var lengdata = [];
                        var seriesdata = [];
                        $.each(datas, function() {

                            var value1 = Math.floor(this.act_complete_pct * 100) / 100;
                            var value2 = Math.floor(this.plan_complete_pct * 100) / 100;
                            var item = {
                                name: this.project_name,
                                type: 'scatter',
                                data: [
                                    [value1, value2, {
                                        id: this.proj_guid
                                    }]
                                ]
                            }
                            seriesdata.push(item);
                        });

                        var myOption = {
                            tooltip: {
                                show: false,
                                trigger: 'axis',
                            },

                            grid: {
                                x: 40,
                                y: 30,
                                x2: 30,
                                y2: 50,
                                borderWidth: "0"
                            },
                            legend: {
                                x: 'center',
                                y: 'bottom',
                                itemGap: 10,
                                selectedMode: true,
                                data: lengdata
                            },

                            calculable: true,
                            xAxis: [{
                                type: 'value',
                                name: '计划',
                                scale: true,
                                min: 0,
                                max: 100,
                                axisLabel: {
                                    formatter: '{value}%'
                                }
                            }],
                            yAxis: [{
                                type: 'value',
                                name: '实际',
                                scale: true,
                                min: 0,
                                max: 100,
                                axisLabel: {
                                    formatter: '{value}%'
                                }
                            }],
                            series: seriesdata
                        };

                        var scatterDiagram1 = echarts.init(document.getElementById("scatterDiagram1"));
                        scatterDiagram1.setOption(myOption);


                        window.addEventListener("resize", function() {
                            scatterDiagram1.resize();
                        });
                    }

                    var p = {};
                    p.EpsProjId = currenttask;

                    $.ajax({
                        url: "/Portal/GetProjectscatterCharts",
                        data: p,
                        type: "POST",
                        success: function(text) {
                            var getData = mini.decode(text);
                            if (getData.success) {
                                LoadChart(getData.list);
                            }
                        }
                    });
                },

                OpenWFNotify: function(LongCode, types, title) {
                    var url = "/Apps/ProjectManagerList.html?EpsProjLongCode=" + LongCode + "&types=" + types;
                    CallAppFunction("appOpenNewWebView", '{"url":"' + url + '","pullUp":"true","pullDown":"true","showTabbar":"true","title":"' + title + '"}', url);
                },

                GetSession: function() {
                    var coordinationProblems = this.coordinationProblems,
                        projectProgress = this.projectProgress,
                        ItemStatusStatistics = this.ItemStatusStatistics,
                        scatterDiagram = this.scatterDiagram,
                        OpenWFNotify = this.OpenWFNotify;

                    $.ajax({
                        url: "/App/GetSession",
                        type: "POST",
                        async: "true",
                        success: function(text) {
                            var getData = mini.decode(text);
                            if (getData.EpsIsProject == 1) {
                                window.location.href = "/Apps/Projectinform.html?EpsProjId=" + getData.EpsProjId + "&OpenType=P";
                            }

                            //企业在建项目
                            projectProgress(getData.EpsProjLongCode);

                            //待解决的问题
                            coordinationProblems(getData.EpsProjLongCode);

                            //项目状态视图 echarts
                            ItemStatusStatistics(getData.EpsProjLongCode);

                            //散点图视图  echarts
                            scatterDiagram(getData.EpsProjId);

                            $("#projectProgress,#coordinationProblems").on("click", function() {
                                var longcode = getData.EpsProjLongCode,
                                    type = $(this).attr("data-type"),
                                    title = $(this).attr("data-name");
                                OpenWFNotify(longcode, type, title);
                            });
                        }
                    });
                },

               events: function() {
                     //初始化轮播图
                    $('#projectUnitSlider').sliderPro({
                       width: 250,
                        height: 200,
                        visibleSize: '100%',
                        forceSize: 'fullWidth',
                        autoSlideSize:true ,
                         autoplay:true ,
                         breakpoints: {
                             500: {
                                 thumbnailWidth: 120,
                                 thumbnailHeight: 50
                             }
                         }
                     });
                }
            };

            projectManagement.init();
        });
    </script>

</body>

</html>