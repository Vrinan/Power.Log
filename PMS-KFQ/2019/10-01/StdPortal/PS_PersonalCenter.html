<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <script src="/Scripts/boot.js?version=<%=AppVersion%>" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/Date.js?version=<%=AppVersion%>" type="text/javascript"></script>
    <script src="/Scripts/PlatForm/ComTools.js?version=<%=AppVersion%>" type="text/javascript"></script>
    
    <!--<link href="/Scripts/plugins/jstree/docs/assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />-->
    <!--<link href="/Scripts/plugins/jstree/docs/assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" />

    <script src="/Scripts/bootstrap/bootstrap/js/bootstrap.js" type="text/javascript"></script>

    <script src="/Scripts/bootstrap/plugins/bootstrap-hover-dropdown/twitter-bootstrap-hover-dropdown.min.js"
            type="text/javascript"></script>-->
    
    <script src="/Scripts/plugins/jQuery/jquery-slimscroll/jquery.slimscroll.min.js"
            type="text/javascript"></script>
    <script src="/Scripts/plugins/jQuery/jquery.cookie.min.js" type="text/javascript"></script>
    <script src="/Scripts/assets/scripts/app.js" type="text/javascript"></script>
    <style>
        /*控制tab页头部高度*/
        .nav > li > a {
            padding-top: 2px;
            padding-bottom: 2px;
        }

        .portlet > .portlet-title > .caption.right {
            float: right;
            font-size: 12px;
            margin-right: 5px;
        }

        .hover {
            cursor: pointer;
        }

        .table {
            table-layout: fixed;
        }

            .table > tbody > tr > trhover {
            }

            .table > tbody > tr > td {
                border-bottom: 1px solid #ddd;
                border-top: 0px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
    </style>
    <style type="text/css">
        /*grid进度条*/
        .progressbar {
            position: relative;
            background: #bbb;
            width: 100%;
            height: 16px;
            overflow: hidden;
        }

        .progressbar-percent {
            position: absolute;
            height: 18px;
            background: #4F94CD;
            left: 0;
            top: 0px;
            overflow: hidden;
            z-index: 1;
        }

        .progressbar-label {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            font-size: 13px;
            color: black;
            z-index: 10;
            text-align: center;
            height: 16px;
            line-height: 16px;
        }
    </style>
    <style>
        .icocolor {
            color: black;
        }

        .projaction {
            margin-left: 6px;
            padding-right: 2px;
        }

        .zhoubao {
            background-color: #CCCC00;
        }

        .baoxiao {
            background-color: #0099CC;
        }

        .jiangjin {
            background-color: #FFCC33;
        }

        .kaipiao {
            background-color: #FF6666;
        }

        .jiesuan {
            background-color: #FF6600;
        }

        .zhengshu {
            background-color: #99CC33;
        }
    </style>
</head>
<body style="margin: 0; padding: 0; overflow-x: hidden; background-gray">
    <div class="row-wrap">
        <div class="row row-hd row-hd-responsive">
            <div class="col-md-8 col-hd-6">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>我的审批
                        </div>
                        <div class="tools">
                        </div>
                    </div>
                    <div class="portlet-body">
                        <iframe style='width:100%;height:100%;' frameborder='0' src='/Form/EditForm/C18537D6-C6B6-4563-84BD-C4842AD08C7A/'></iframe>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-hd-6">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>快捷操作
                        </div>
                        <div class="tools">
                            <a href="" class="collapse" style="background-color:#DCDCDC"></a>
                            <a href="#portlet-config" data-toggle="modal" class="config" style="background-color:#DCDCDC"></a>
                            <a href="" class="reload" style="background-color:#DCDCDC"></a>
                            <a href="" class="remove" style="background-color:#DCDCDC"></a>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <iframe style='width:100%;height:100%;' frameborder='0' src='/Form/EditForm/61507CD7-C60E-4DE9-883A-C4A30E050F31/'></iframe>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-hd-6" name="View_KFQ_Auditing_Record_Detail" id="View_KFQ_Auditing_Record_Detail">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>历史审批记录
                        </div>
                        <div class="caption right">
                            <a href="/Form/EditForm/7e40d4c3-4dbe-48fa-9002-faea9f7be09b/" style="color:#666"><i class="fa fa-bars"></i>更多</a>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div id="View_KFQ_Auditing_Record_Detail" class="mini-datagrid" showColumns="false" showpager="false"
                             style="width: 100%; height: 100%;" pageSize="15" idField="Id" onrowdblclick="onDrawAuditing">
                            <div property="columns">
                                <div width="80%" field="Name" name="Name" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="标题" align="left">标题<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                <div field="Adder_Name" name="Adder_Name" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="录入人" align="left">录入人<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                <div field="Add_Time" name="Add_Time" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="录入时间" align="left" dateformat="yyyy-MM-dd">录入时间<input property="editor" class="mini-datepicker" style="width: 100%;" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-hd-6">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>通知公告
                        </div>
                        <div class="caption right">
                            <a href="/Form/EditForm/93086420-7fde-42f4-8b4f-f6e16e9dec51/" style="color:#666"><i class="fa fa-bars"></i>更多</a>
                        </div>
                    </div>
                    <div class="portlet-body" style="overflow: hidden ;">
                        <table class="table table-condensed table-hover">
                            <tbody id="PS_ProjectEvents"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!--<div class="col-md-6 col-hd-6">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>我的消息
                        </div>
                        <div class="tools">
                        </div>
                    </div>
                    <div class="portlet-body">
                        <iframe style='width:100%;height:100%;' frameborder='0' src='/Form/EditForm/a894cc31-b9d3-40b3-a76d-f39cb2bea59f/'></iframe>
                    </div>
                </div>
            </div>-->
            <div class="col-md-4 col-hd-6">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>发文通知
                        </div>
                        <div class="caption right">
                            <a href="/Form/EditForm/ffb3893c-3825-4195-8e3c-3448ba73ebb9/" style="color:#666"><i class="fa fa-bars"></i>更多</a>
                        </div>
                    </div>
                    <div class="portlet-body" style="overflow: hidden ;">
                        <table class="table table-condensed table-hover">
                            <tbody id="PS_FileContact"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-8 col-hd-6" name="View_KFQ_ContractPayment" id="View_KFQ_ContractPayment">
                <div class="portlet box blue">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-calendar"></i>合同付款
                        </div>
                        <div class="caption right">
                            <a href="/Form/EditForm/86372b8d-a5da-41bc-8c10-6f5eca7d6628/" style="color:#666"><i class="fa fa-bars"></i>更多</a>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <div id="View_KFQ_ContractPayment" ondrawcell="onDrawCellLeave" class="mini-datagrid" showpager="false" style="width: 100%; height: 100%;" pageSize="15" idField="Id">
                            <div property="columns">
                                <div width="15%" field="Code" name="Code" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="付款编号" align="left">付款编号<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                <div width="30%" field="Title" name="Title" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="付款名称" align="left">付款名称<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                <div width="20%" field="ApplyMny" name="ApplyMny" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="付款金额" align="left" numberformat="n2">付款金额<input property="editor" class="mini-spinner" style="width: 100%;" /></div>
                                <div field="fukuanrenName" name="fukuanrenName" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="付款人" align="left">付款人<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                <div field="RegHumName" name="RegHumName" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="录入人" align="left">录入人<input property="editor" class="mini-textbox" style="width: 100%;" /></div>
                                <div field="RegDate" name="RegDate" headeralign="center" guideid="" datatype="" allowsort="true" currencyunit="" header="录入时间" align="left" dateformat="yyyy-MM-dd">录入时间<input property="editor" class="mini-datepicker" style="width: 100%;" /></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script type="text/javascript" hasvelocity="true">
        $session = { HumanId: "$!CurrentSession.HumanId", HumanCode: "$!CurrentSession.HumanCode", EpsProjId: "$!CurrentSession.EpsProjId" }
    </script>
    <script type="text/javascript">
        mini.parse();
        var currentperiod = "";
        $(function () {
            //初始化加载数据
            //1、通知公告
            $.ajax({
                url: "/Form/GridPageLoad",
                data: { KeyWord: 'PS_ProjectEvents', KeyWordType: 'BO', select: 'Id,Code,Title,RegDate', swhere: '', sort: 'RegDate desc', index: '0', size: '8' },

                type: 'post',
                success: function (text) {
                    var o = mini.decode(text);
                    if (o.success) {
                        var data = mini.decode(o.data.value);
                        var html = '';
                        for (var i = 0; i < data.length; i++) {
                            html += "<tr class='hover' onclick=\"OnViewForm('494875E9-B0DF-4701-9BC2-DD52AAF413B1','" + data[i].Id + "')\">";
                            html += ("<td>" + data[i].Title + "</td>");
                            html += ("<td width='100px'>" + data[i].RegDate.Format("yyyy-MM-dd") + "</td>");
                            html += "</tr>";
                        }
                        if (data.length == 0) {
                            html = "<p class='text-center' style:'font-size: 12px;'>暂无通知信息</p>"
                        }
                        $("#PS_ProjectEvents").html(html);

                    }
                }
            })

            //add1、发文通知
            GetNotification();

            //add2、历史审批记录
            GetAuditing();

            //add3、合同付款
            GetContractPayment();
        })

        function OnViewForm(formid, keyvalue) {
            mini.open({
                url: '/Form/ViewForm/' + formid + '/' + keyvalue,
                showMaxButton: true,
                width: 1200,
                height: 600
            })
        }

        //add1、发文通知
        function GetNotification() {
            //var p = { KeyWord: 'View_SF_Notification', KeyWordType: 'VIEWENTITY', select: '*', swhere: '', sort: 'RegDate desc', index: '0', size: '8' };
            var p = { KeyWord: 'PS_FileContact', KeyWordType: 'OB', select: 'Id,Code,Title,ProposedDate', swhere: '', sort: 'ProposedDate desc', index: '0', size: '8' };
            if ($session.HumanId == "ad000000-0000-0000-0000-000000000000") {
                p.swhere = "1=1 and ContactType=3";
            }
            else {
                p.swhere += "ContactType=3 and DistriDeptId like '%" + $session.DeptId + "%' or DistriHumId like '%" + $session.HumanId + "%' "
            }

            $.ajax({
                url: "/Form/GridPageLoad",
                data: p,
                type: 'post',
                success: function (text) {
                    var o = mini.decode(text);
                    if (o.success) {
                        var data = mini.decode(o.data.value);
                        var html = '';
                        for (var i = 0; i < data.length; i++) {
                            html += "<tr class='hover' onclick=\"OnViewForm('929739a9-8b4e-4595-8ffc-6ea70ff3dea2','" + data[i].Id + "')\">";
                            html += ("<td>" + data[i].Title + "</td>");
                            html += ("<td width='100px'>" + data[i].ProposedDate.Format("yyyy-MM-dd") + "</td>");
                            html += "</tr>";
                        }
                        if (data.length == 0) {
                            html = "<p class='text-center' style:'font-size: 12px;'>暂无通知信息</p>"
                        }
                        $("#PS_FileContact").html(html);

                    }
                }
            })
        }

        //add2
        function GetAuditing() {
            var p = { KeyWord: 'View_KFQ_Auditing_Record_Detail', KeyWordType: 'VIEWENTITY', select: 'KeyWord,ID,REC_SID,sid,State,Name,Add_Time', swhere: '', sort: 'Add_Time desc', index: '0', size: '8' };
            if ($session.HumanId == "ad000000-0000-0000-0000-000000000000") {
                p.swhere = "1=1";
            } else {
                p.swhere += " sid in(select distinct ddi_sid from Send_Rec where shr in(select uniqueid from pb_human where Id ='" + $session.HumanId + "'))"
            }
            $.ajax({
                url: "/Form/GridPageLoad",
                data: p,
                type: 'post',
                success: function (text) {
                    var o = mini.decode(text);
                    if (o.success) {
                        var data = mini.decode(o.data.value);
                        mini.get("View_KFQ_Auditing_Record_Detail").setData(data);
                    }
                    else
                        mini.get("View_KFQ_Auditing_Record_Detail").setData("");
                }
            })
        }

        function onDrawAuditing(e) {
            debugger;
            var keyword = e.record.KeyWord;
            var formid = e.record.ID;
            var uniqueId = String(e.record.REC_SID);

            var exec = {};  //对象
            exec.KeyWord = "AUDITING_RECORD";   //bo的KeyWord
            exec.MethodName = "GetId"; //方法名称
            //如果是数据集的话，要加上 exec.KeyWordType="ViewEntity";
            exec.MethodParams = {}; //方法参数
            var params = exec.MethodParams;
            params.keyword = keyword;
            params.uniqueId = uniqueId;
            var txt = mini.encode(exec); //对象转换成字符串

            $.ajax({
                url: "/API/Exec",
                type: "POST",
                data: { jsonData: txt }, //对象字符串传递给 jsonData变量
                cache: false,
                success: function (text) {
                    debugger;
                    var tmp = mini.decode(text);
                    if (tmp.success) {
                        var result = tmp.data.value;
                        if (result != "") {
                            var url = "/Form/ValidForm/" + formid + "/view/" + result;
                            mini.open({
                                url: url,
                                width: 900,
                                height: 550
                            });
                        }
                    }
                    else
                        Power.ui.alert(tmp.message + "111");
                }
            });

        }

        //add3
        function GetContractPayment() {
            var p = { KeyWord: 'View_KFQ_ContractPayment', KeyWordType: 'VIEWENTITY', select: 'Code,Title,ApplyMny,fukuanrenName,RegHumName,RegDate,Id', swhere: '', sort: 'RegDate desc', index: '0', size: '7' };
            if ($session.HumanId == "ad000000-0000-0000-0000-000000000000") {
                p.swhere = "1=1";
            } else {
                p.swhere += " fukuanrenName_Id ='" + $session.HumanId + "'"
            }
            $.ajax({
                url: "/Form/GridPageLoad",
                data: p,
                type: 'post',
                success: function (text) {
                    var o = mini.decode(text);
                    if (o.success) {
                        var data = mini.decode(o.data.value);
                        mini.get("View_KFQ_ContractPayment").setData(data);
                    }
                    else
                        mini.get("View_KFQ_ContractPayment").setData("");
                }
            })
        }
        function onDrawCellLeave(e) {
            if (e.field == "Code") {
                switch (e.record.PaymentType) {
                    //合同支付
                    case "P1":
                        e.cellHtml = "<a href='javascript:;' onclick=\"OnViewForm('6f729598-179f-4189-8deb-215e99a349d1','" + e.record.Id + "')\">" + e.record.Code + "</a>";
                        break;
                        //无合同支付
                    case "P2":
                        e.cellHtml = "<a href='javascript:;' onclick=\"OnViewForm('159198f1-3f06-455b-a35b-89d6728eef73','" + e.record.Id + "')\">" + e.record.Code + "</a>";
                        break;
                }
            }
        }
    </script>
</body>

</html>
